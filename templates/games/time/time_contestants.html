<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
  <meta name="theme-color" content="#4f46e5"/>
  <title>{{ session.team1_name }} Ø¶Ø¯ {{ session.team2_name }} â€” ØµÙØ­Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† (ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„ÙˆÙ‚Øª)</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg1:#7c3aed; --bg2:#5b21b6; --bg3:#1e1b4b;
      --glass:rgba(255,255,255,.12); --glass-b:rgba(255,255,255,.22);
      --ring:rgba(255,255,255,.3);
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --btn1:#ef4444; --btn2:#dc2626; --btn3:#b91c1c;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; padding:0; color:#fff;
      background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
      font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,Arial;
      min-height:100vh; overflow:hidden;
    }

    /* ØªÙˆØ²ÙŠØ¹ Ø£ÙÙ‚ÙŠ: ÙŠØ³Ø§Ø± (ÙØ±ÙŠÙ‚ 2) â€” ÙˆØ³Ø· (Ø§Ù„ØµÙˆØ±Ø©) â€” ÙŠÙ…ÙŠÙ† (ÙØ±ÙŠÙ‚ 1) */
    .layout{
      position:fixed; inset:0;
      display:grid; grid-template-columns: 1fr minmax(0, 55vw) 1fr;
      align-items:center; gap: min(2vw, 24px);
      padding: min(2.2vw, 22px);
    }

    /* Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ­ÙƒÙ… Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚ (Ù…Ø¤Ù‚Øª + Ø²Ø±) */
    .side{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap: 12px;
    }
    /* Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø§Ù„ÙˆÙ‚Øª */
    .timer{
      width: min(92%, 300px);
      background: var(--glass); border: 2px solid var(--glass-b);
      border-radius: 18px; padding: 12px; text-align:center;
      backdrop-filter: blur(14px);
      box-shadow: 0 16px 40px rgba(0,0,0,.25);
    }
    .name{ font-weight:900; font-size:1.05rem; opacity:.95; margin-bottom:6px }
    .time{
      font-weight:900; font-size: 3rem; line-height:1; letter-spacing:1px;
      text-shadow: 2px 2px 6px rgba(0,0,0,.35);
    }
    .timer.active{ outline:4px solid rgba(34,197,94,.65); box-shadow:0 0 0 6px rgba(34,197,94,.18) inset }

    /* Ø²Ø± ÙƒÙ„ Ù„Ø§Ø¹Ø¨ (ØªØ­Øª Ø§Ù„Ù…Ø¤Ù‚Ù‘Øª Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Ù‚Ø±ÙŠØ¨ Ù…Ù†Ù‡) */
    .buzz-btn{
      --size: clamp(110px, 20vw, 180px);
      width: var(--size); height: var(--size);
      border-radius: 999px; border: 0; cursor:pointer; position:relative;
      display:grid; place-items:center; font-weight:900; letter-spacing:.4px;
      font-size: clamp(1.05rem, 2.4vw, 1.5rem); color:#fff; outline:none;
      background:
        radial-gradient(140% 60% at 50% 8%, rgba(255,255,255,.35), transparent 40%),
        linear-gradient(165deg, var(--btn1) 0%, var(--btn2) 45%, var(--btn3) 100%);
      box-shadow: 0 18px 35px rgba(239,68,68,.45), inset 0 -10px 18px rgba(0,0,0,.25), inset 0 8px 12px rgba(255,255,255,.08);
      transition: transform .12s ease, filter .12s ease;
    }
    .buzz-btn:hover{ transform: translateY(-2px) scale(1.03) }
    .buzz-btn:active{ transform: translateY(1px) scale(.97); filter: saturate(1.1) }
    .buzz-btn:disabled{
      background: linear-gradient(165deg, #6b7280, #4b5563);
      box-shadow: 0 10px 20px rgba(0,0,0,.25), inset 0 -10px 18px rgba(0,0,0,.2);
      cursor:not-allowed;
    }

    /* Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ù…Ù†ØªØµÙ */
    .frame{
      width: 100%; height: min(82vh, 760px);
      background: #000; border-radius: 18px; overflow:hidden;
      display:grid; place-items:center; border:1px solid var(--ring);
      box-shadow:0 22px 60px rgba(0,0,0,.4);
    }
    .frame img{ max-width:100%; max-height:100%; display:block }

    /* Ø§Ù„Ø´Ø¹Ø§Ø± */
    .logo{
      position:fixed; top:12px; right:12px; background:#fff; color:#111827;
      border-radius:14px; padding:8px 12px; z-index:10;
      box-shadow:0 12px 28px rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.35);
    }
    .logo img{ max-height:46px; display:block }

    /* Ù„Ù…Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ù†Ø¯ Ø±Ø¨Ø· WS) */
    .conn{
      position:fixed; top:12px; left:12px; z-index:10; padding:8px 12px; border-radius:999px; font-weight:800; font-size:.85rem;
      background: rgba(239,68,68,.92); /* Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ù†Ù‚Ø·Ø¹ */
    }
    .conn.connected{ background: rgba(34,197,94,.92) }
    .conn.partial{ background: rgba(245,158,11,.92) }

    @media (max-width: 980px){
      .time{ font-size: 2.4rem }
    }
    @media (max-width: 720px){
      .layout{ grid-template-columns: 1fr minmax(0, 54vw) 1fr; gap:12px; }
      .time{ font-size: 2rem }
    }
  </style>
</head>
<body>

  <!-- Ù„Ù…Ø¨Ø© Ø§ØªØµØ§Ù„ (Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù…Ø¹ WS) -->
  <div id="conn" class="conn">ğŸ”´ Ù…Ù†Ù‚Ø·Ø¹</div>

  <!-- Ø´Ø¹Ø§Ø± -->
  <div class="logo">
    <img src="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png" alt="ÙˆØ´ Ø§Ù„Ø¬ÙˆØ§Ø¨"/>
  </div>

  <!-- ØªÙˆØ²ÙŠØ¹ Ø£ÙÙ‚ÙŠ: ÙŠØ³Ø§Ø± (team2) â€” ÙˆØ³Ø· (image) â€” ÙŠÙ…ÙŠÙ† (team1) -->
  <section class="layout">

    <!-- ÙŠØ³Ø§Ø±: Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
    <aside class="side">
      <div id="timer2" class="timer">
        <div class="name">ğŸŸ  {{ session.team2_name }}</div>
        <div id="t2" class="time">1:00</div>
      </div>
      <button id="btn2" class="buzz-btn" type="button" aria-label="Ø¥ÙŠÙ‚Ø§Ù/ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¯ÙˆØ± Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„">ØªÙ…</button>
    </aside>

    <!-- Ø§Ù„Ù…Ù†ØªØµÙ: Ø§Ù„ØµÙˆØ±Ø© -->
    <main class="frame">
      <img id="img" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©"/>
    </main>

    <!-- ÙŠÙ…ÙŠÙ†: Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„ -->
    <aside class="side">
      <div id="timer1" class="timer">
        <div class="name">ğŸŸ¢ {{ session.team1_name }}</div>
        <div id="t1" class="time">1:00</div>
      </div>
      <button id="btn1" class="buzz-btn" type="button" aria-label="Ø¥ÙŠÙ‚Ø§Ù/ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¯ÙˆØ± Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ">ØªÙ…</button>
    </aside>

  </section>

<script>
  // ===== Ø«ÙˆØ§Ø¨Øª =====
  const SESSION_ID = '{{ session.id }}';
  const API_INIT   = "{% url 'games:api_time_get_current' %}?session_id=" + encodeURIComponent(SESSION_ID);
  // WS Ø³ÙŠÙÙØ¹Ù‘Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€Consumer:
  const WS_URL     = `${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws/time/${SESSION_ID}/?role=contestants`;

  // ===== Ø¹Ù†Ø§ØµØ± =====
  const el = {
    conn: document.getElementById('conn'),
    img:  document.getElementById('img'),
    t1:   document.getElementById('t1'),
    t2:   document.getElementById('t2'),
    box1: document.getElementById('timer1'),
    box2: document.getElementById('timer2'),
    b1:   document.getElementById('btn1'),
    b2:   document.getElementById('btn2'),
  };

  // ===== Ø­Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ© =====
  let active = 'team1';           // Ù…Ù† ÙŠÙ„Ø¹Ø¨ Ø§Ù„Ø¢Ù†
  let t1ms = 60000, t2ms = 60000; // Ø£Ø²Ù…Ù†Ø© Ù…ØªØ¨Ù‚ÙŠØ© Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚ (ms)
  let ticking = false;
  let last = performance.now();
  let lock = false;               // Ù…Ù†Ø¹ Ø§Ù„Ø·Ù‚Ø·Ù‚Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø±

  function fmt(ms){
    ms = Math.max(0, Math.floor(ms));
    const s = Math.floor(ms/1000), m = Math.floor(s/60), r = s%60;
    return `${m}:${String(r).padStart(2,'0')}`;
  }
  function reflect(){
    el.t1.textContent = fmt(t1ms);
    el.t2.textContent = fmt(t2ms);
    if (active==='team1'){ el.box1.classList.add('active'); el.box2.classList.remove('active'); }
    else                 { el.box2.classList.add('active'); el.box1.classList.remove('active'); }
  }

  function tick(now){
    if (!ticking) return;
    const dt = now - last; last = now;
    if (active==='team1'){ t1ms -= dt; if (t1ms<0) t1ms=0; }
    else                 { t2ms -= dt; if (t2ms<0) t2ms=0; }
    reflect();
    requestAnimationFrame(tick);
  }
  function startTick(){ if (!ticking){ ticking=true; last=performance.now(); requestAnimationFrame(tick);} }
  function stopTick(){ ticking=false; }

  // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ± (Ø²Ø± Ø£ÙŠ Ù„Ø§Ø¹Ø¨)
  function switchTurn(nextActive){
    // Ù„Ùˆ Ø¶ØºØ· Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ØµØ­ÙŠØ­: Ù†Ø¨Ø¯Ù‘Ù„ Ù„Ù„Ø«Ø§Ù†ÙŠ
    if (lock) return;
    lock = true; setTimeout(()=>lock=false, 180);

    // Ù„Ø§ ØªØ³Ù…Ø­ Ù„Ù…Ù† Ù„ÙŠØ³ Ø¯ÙˆØ±Ù‡ Ø¨Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    if (nextActive==='team1' && active!=='team2') return;
    if (nextActive==='team2' && active!=='team1') return;

    active = (active==='team1') ? 'team2' : 'team1';
    reflect();
    // Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø³Ù†Ø¨Ø«Ù‘ Ù„Ù„Ø³ÙŠØ±ÙØ± Ø¹Ø¨Ø± WS:
    // ws?.readyState===1 && ws.send(JSON.stringify({type:'timer_switched', active_team:active, team1_ms:t1ms|0, team2_ms:t2ms|0}));
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© + ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¯Ù‘
  async function init(){
    try{
      const r = await fetch(API_INIT, {cache:'no-store'});
      if (r.status===410){ alert('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©'); return; }
      if (!r.ok) return;
      const d = await r.json();

      active = d.active_team || 'team1';
      t1ms = +d.team1_ms || 60000;
      t2ms = +d.team2_ms || 60000;

      if (d.current && d.current.image_url){ el.img.src = d.current.image_url; }

      reflect(); startTick();
    }catch(e){}
  }

  // WS (Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ØŒ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ Ø­Ø§Ù„ÙŠÙ‹Ø§)
  let ws=null, hb=null;
  function setConn(){
    const c = ws && ws.readyState===1;
    el.conn.className = 'conn ' + (c ? 'connected' : 'disconnected');
    el.conn.textContent = c ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ Ù…Ù†Ù‚Ø·Ø¹';
  }
  function connectWS(){
    try{ ws = new WebSocket(WS_URL); }catch{ setConn(); return; }
    ws.onopen = ()=>{ setConn(); hb && clearInterval(hb); hb=setInterval(()=>{ try{ ws.readyState===1 && ws.send(JSON.stringify({type:'ping'})); }catch{} },20000); };
    ws.onmessage = (ev)=>{
      let d={}; try{ d=JSON.parse(ev.data||'{}'); }catch{ return; }

      // Ø§Ø³ØªÙ„Ø§Ù… ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ù…Ù‚Ø¯Ù…
      if (d.type==='puzzle_updated' && d.image_url){ el.img.src = d.image_url; }

      // Ø§Ø³ØªÙ„Ø§Ù… Ø­Ø§Ù„Ø© Ù…Ø¤Ù‚Øª Ù…ØµØ­Ø­Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… (Ù„Ùˆ Ø§Ø­ØªØ¬Ù†Ø§ Ù…Ø±Ø¬Ø¹ÙŠØ© Ù…Ø±ÙƒØ²ÙŠØ©)
      if (d.type==='timer_state'){
        stopTick();
        if (typeof d.team1_ms==='number') t1ms = d.team1_ms;
        if (typeof d.team2_ms==='number') t2ms = d.team2_ms;
        active = d.active_team || active;
        reflect(); startTick();
      }
    };
    ws.onclose = ()=>{ hb && clearInterval(hb); setConn(); };
    ws.onerror = ()=>{ try{ ws.close(); }catch{} };
  }

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  el.b1.addEventListener('click', ()=>switchTurn('team2')); // Ø²Ø± Ø§Ù„ÙØ±ÙŠÙ‚1 ÙŠÙ…Ø±Ù‘Ø± Ø§Ù„Ø¯ÙˆØ± Ù„Ù„ÙØ±ÙŠÙ‚2
  el.b2.addEventListener('click', ()=>switchTurn('team1')); // Ø²Ø± Ø§Ù„ÙØ±ÙŠÙ‚2 ÙŠÙ…Ø±Ù‘Ø± Ø§Ù„Ø¯ÙˆØ± Ù„Ù„ÙØ±ÙŠÙ‚1

  document.addEventListener('DOMContentLoaded', ()=>{
    init();
    // Ø³Ù†ÙØ¹Ù„ WS Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:
    // connectWS();
  });
</script>
</body>
</html>
