<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>خلية الحروف - المقدم</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
  
  <script>
    window.sessionData = {
      sessionId: '{{ session.id }}',
      csrfToken: '{{ csrf_token }}',
      team1Name: '{{ session.team1_name }}',
      team2Name: '{{ session.team2_name }}',
      displayUrl: '{% url "games:letters_display" session.display_link %}',
      contestantsUrl: '{% url "games:letters_contestants" session.contestants_link %}',
      packageName: '{{ session.package.get_game_type_display }} - حزمة {{ session.package.package_number }}',
      arabicLetters: {{ arabic_letters_json|safe }}
    };
  </script>

  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Tajawal', sans-serif;
      min-height: 100vh;
      padding: 10px;
      margin: 0;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 15px;
      max-width: 100%;
      margin: 0 auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    /* إشعار ضغط الزر - محسّن */
    #buzzNotification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      padding: 20px 25px;
      border-radius: 15px;
      font-weight: bold;
      display: none;
      box-shadow: 0 15px 35px rgba(239, 68, 68, 0.4);
      z-index: 9999;
      font-size: 18px;
      max-width: 320px;
      animation: buzzPulse 0.6s ease-in-out infinite alternate;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    @keyframes buzzPulse {
      from { 
        transform: scale(1); 
        box-shadow: 0 15px 35px rgba(239, 68, 68, 0.4); 
      }
      to { 
        transform: scale(1.05); 
        box-shadow: 0 20px 45px rgba(239, 68, 68, 0.6); 
      }
    }

    .buzz-controls {
      margin: 15px 0;
      text-align: center;
    }

    .buzz-reset-btn {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
    }

    .buzz-reset-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
    }

    .honeycomb-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 15px 0;
      padding: 10px;
    }

    .honeycomb-svg {
      width: 100%;
      max-width: 100vw;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    .hex-cell {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .hex-cell:hover .hex-shape {
      fill: #f0f9ff;
      stroke-width: 4;
      transform: scale(1.05);
    }

    .hex-cell.team1 .hex-shape {
      fill: #22c55e;
      stroke: #15803d;
      stroke-width: 4;
    }

    .hex-cell.team1 .hex-text {
      fill: white;
      font-weight: bold;
    }

    .hex-cell.team2 .hex-shape {
      fill: #f97316;
      stroke: #c2410c;
      stroke-width: 4;
    }

    .hex-cell.team2 .hex-text {
      fill: white;
      font-weight: bold;
    }

    .hex-shape {
      fill: white;
      stroke: #6b46c1;
      stroke-width: 3;
      transition: all 0.3s ease;
      transform-origin: center;
    }

    .hex-text {
      fill: #6b46c1;
      font-family: 'Tajawal', sans-serif;
      font-size: 130px;
      font-weight: 900;
      text-anchor: middle;
      dominant-baseline: central;
      pointer-events: none;
    }

    .info-panel {
      background: white;
      border-radius: 15px;
      padding: 12px;
      margin: 10px 0;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .question-panel {
      background: #f8fafc;
      border: 2px solid #4c51bf;
      border-radius: 15px;
      padding: 15px;
      margin: 15px 0;
      display: none;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .btn-primary {
      background: linear-gradient(135deg, #4c51bf, #667eea);
      border: none;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: bold;
      font-size: 14px;
    }

    .score-display {
      font-size: 1.1rem;
      font-weight: bold;
      text-align: center;
      padding: 8px;
      border-radius: 10px;
      margin: 3px;
    }

    .team1-score {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      color: #22c55e;
      border: 2px solid #22c55e;
    }

    .team2-score {
      background: linear-gradient(135deg, #fed7aa, #fdba74);
      color: #f97316;
      border: 2px solid #f97316;
    }

    .timer-display {
      font-size: 2rem;
      font-weight: bold;
      color: #dc2626;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    /* تحسينات للجوال */
    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 10px; border-radius: 15px; }
      .honeycomb-container .position-absolute img { max-height: 35px !important; right: 10px !important; }
      .honeycomb-container { margin: 10px 0; padding: 5px; }
      .honeycomb-svg { max-width: 95vw; width: 100%; transform: scale(1.0); transform-origin: center; }
      .hex-text { font-size: 150px; font-weight: 900; }
      .score-display { font-size: 1rem; padding: 6px; margin: 2px; }
      .timer-display { font-size: 1.8rem; }
      .question-panel { padding: 12px; margin: 10px 0; }
      .scores-mobile { display: flex; gap: 8px; margin: 10px 0; }
      .scores-mobile .score-display { flex: 1; font-size: 0.95rem; padding: 6px 4px; }
      .scores-mobile .btn { font-size: 12px; padding: 2px 6px; margin: 0 1px; }
      .info-panel { padding: 8px; margin: 8px 0; }
      .btn-primary { font-size: 12px; padding: 6px 10px; }
      h2 { font-size: 1.3rem; margin-bottom: 10px; }
      #buzzNotification { top: 10px; right: 10px; font-size: 16px; padding: 15px 20px; max-width: 90%; }
    }

    /* تحسينات للشاشات الكبيرة */
    @media (min-width: 769px) {
      .container { max-width: 1000px; padding: 20px; }
      .honeycomb-svg { max-width: 650px; transform: scale(0.85); transform-origin: center; }
      .hex-text { font-size: 110px; }
      .score-display { font-size: 1.3rem; padding: 12px; }
      .timer-display { font-size: 2.5rem; }
      .question-panel { padding: 20px; margin: 20px 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-3">🎯 خلية الحروف - المقدم</h2>
    
    <!-- مؤقت الجلسة المجانية -->
    {% if session.package.is_free and time_remaining %}
    <div class="alert alert-warning text-center mb-3" id="sessionTimer">
      <strong>⏰ الجلسة المجانية - الوقت المتبقي:</strong> 
      <span id="timeRemaining" class="fw-bold text-danger"></span>
    </div>
    {% endif %}
    
    <!-- معلومات الجلسة -->
    <div class="row justify-content-center mb-3">
      <div class="col-12">
        <div class="card shadow-sm border-0" style="background: #f9fafb;">
          <div class="card-body text-center p-2">
            <p class="mb-2 fw-bold fs-6">🔗 روابط الجلسة:</p>
            <div class="d-flex flex-wrap justify-content-center gap-1">
              <button class="btn btn-sm btn-outline-secondary" onclick="copyLink(window.location.origin + window.sessionData.contestantsUrl)">
                👥 المتسابقين
              </button>
              <button class="btn btn-sm btn-outline-secondary" onclick="copyLink(window.location.origin + window.sessionData.displayUrl)">
                🖥️ شاشة العرض
              </button>
              <button class="btn btn-sm btn-outline-secondary" onclick="copyLink(window.location.href)">
                🧑‍🏫 المقدم
              </button>
            </div>
            <small id="copySuccess" style="display: none; opacity: 0; transition: opacity 0.3s ease;" class="text-success mt-2 d-block">✅ تم النسخ بنجاح!</small>
          </div>
        </div>
      </div>
    </div>

    <!-- تحكم الطنطيط -->
    <div class="buzz-controls">
      <button class="buzz-reset-btn" onclick="resetBuzzer()">🔄 فك قفل الزر</button>
    </div>

    <!-- عرض السؤال -->
    <div id="questionDisplay" class="alert alert-light text-dark mt-4 text-center fs-4 fw-bold">
      اضغط على أي حرف لعرض السؤال
    </div>

    <!-- خلية الحروف SVG مع اللوجو -->
    <div class="honeycomb-container position-relative">
      <!-- اللوجو فوق يمين الخلية -->
      <div class="position-absolute" style="top: 5px; right: 20px; z-index: 10;">
        <img src="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png" 
             alt="وش الجواب" 
             style="max-height: 45px; width: auto; opacity: 0.9;" 
             class="img-fluid">
      </div>
      
      <svg class="honeycomb-svg" viewBox="0 0 1800 1200" xmlns="http://www.w3.org/2000/svg" id="honeycombSvg">
        <defs>
          <polygon id="greenTop" points="0,0 1800,0 1350,200 450,200"/>
          <polygon id="greenBottom" points="450,1000 1350,1000 1800,1200 0,1200"/>
          <polygon id="orangeLeft" points="0,0 450,200 450,1000 0,1200"/>
          <polygon id="orangeRight" points="1350,200 1800,0 1800,1200 1350,1000"/>
        </defs>
        <rect width="1800" height="1200" rx="40" fill="#4ade80"/>
        <use href="#orangeLeft" fill="#fb923c"/>
        <use href="#orangeRight" fill="#fb923c"/>
        <use href="#greenTop" fill="#4ade80"/>
        <use href="#greenBottom" fill="#4ade80"/>
      </svg>
    </div>

    <!-- لوحة الأسئلة -->
    <div class="question-panel" id="questionPanel">
      <h4 class="mb-3">❓ السؤال - حرف <span id="currentLetter">أ</span></h4>
      <div class="mb-3">
        <strong>السؤال:</strong> <span id="mainQuestion">السؤال سيظهر هنا</span>
      </div>
      <div class="mb-3">
        <strong>الإجابة:</strong> <span id="mainAnswer" style="color: #22c55e; font-weight: bold;">الإجابة</span>
      </div>
      <div class="row">
        <div class="col-md-6 mb-2">
          <div class="card" style="cursor: pointer; background: #fef3c7;" onclick="switchQuestion('alt1')">
            <div class="card-body p-2">
              <h6 class="mb-1">💡سؤال بديل</h6>
              <p class="mb-1 small" id="alt1Question">سؤال بديل</p>
              <small><strong>الإجابة:</strong> <span id="alt1Answer">إجابة</span></small>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-2">
          <div class="card" style="cursor: pointer; background: #fef3c7;" onclick="switchQuestion('alt2')">
            <div class="card-body p-2">
              <h6 class="mb-1">💡 سؤال بديل</h6>
              <p class="mb-1 small" id="alt2Question">سؤال بديل</p>
              <small><strong>الإجابة:</strong> <span id="alt2Answer">إجابة</span></small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- النقاط للجوال -->
    <div class="scores-mobile d-md-none">
      <div class="score-display team1-score">
        🟢 {{ session.team1_name }}: <span id="team1Score">0</span>
        <div class="mt-1">
          <button class="btn btn-sm btn-light" onclick="updateScore('team1', 1)">+</button>
          <button class="btn btn-sm btn-light" onclick="updateScore('team1', -1)">-</button>
        </div>
      </div>
      <div class="score-display team2-score">
        🟠 {{ session.team2_name }}: <span id="team2Score">0</span>
        <div class="mt-1">
          <button class="btn btn-sm btn-light" onclick="updateScore('team2', 1)">+</button>
          <button class="btn btn-sm btn-light" onclick="updateScore('team2', -1)">-</button>
        </div>
      </div>
    </div>

    <!-- النقاط للشاشات الكبيرة -->
    <div class="row d-none d-md-flex mb-3">
      <div class="col-md-6">
        <div class="score-display team1-score">
          {{ session.team1_name }}: <span id="team1ScoreDesktop">0</span>
          <div class="mt-2">
            <button class="btn btn-sm btn-light me-2" onclick="updateScore('team1', 1)">+</button>
            <button class="btn btn-sm btn-light" onclick="updateScore('team1', -1)">-</button>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="score-display team2-score">
          {{ session.team2_name }}: <span id="team2ScoreDesktop">0</span>
          <div class="mt-2">
            <button class="btn btn-sm btn-light me-2" onclick="updateScore('team2', 1)">+</button>
            <button class="btn btn-sm btn-light" onclick="updateScore('team2', -1)">-</button>
          </div>
        </div>
      </div>
    </div>

    <!-- إشعار ضغط الزر -->
    <div id="buzzNotification">
      🚨 المتسابق ضغط الزر!
    </div>
  </div>

<script>
  // ===================== المتغيرات العامة =====================
  const sessionId  = '{{ session.id }}';
  const hostToken  = '{{ host_token }}';
  const team1Name  = '{{ session.team1_name }}';
  const team2Name  = '{{ session.team2_name }}';
  const lettersArr = (window.sessionData && window.sessionData.arabicLetters) || [];

  let socket = null;
  let reconnectDelay = 1000;
  const maxDelay = 5000;

  // حالة الواجهة
  const cellStates = {};
  let lastClickedLetter = null;

  // ===================== أدوات مساعدة =====================
  function qs(sel){ return document.querySelector(sel); }
  function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }

  // نسخ الروابط
  async function copyLink(text) {
    try {
      await navigator.clipboard.writeText(text);
      const el = document.getElementById('copySuccess');
      el.style.display = 'block';
      requestAnimationFrame(() => { el.style.opacity = '1'; });
      setTimeout(() => { el.style.opacity = '0'; setTimeout(() => { el.style.display = 'none'; }, 300); }, 1400);
    } catch(e) {
      alert('تعذّر النسخ، انسخ الرابط يدويًا:\n' + text);
    }
  }
  window.copyLink = copyLink;

  // صوتيات
  function tone(freq=800, dur=300, gain=0.5){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator(), g = ctx.createGain();
      osc.connect(g); g.connect(ctx.destination);
      osc.frequency.value = freq; g.gain.setValueAtTime(gain, ctx.currentTime);
      osc.start(); osc.stop(ctx.currentTime + (dur/1000));
    }catch{}
  }
  function playBuzzSound(){ tone(800, 300, 0.5); }

  // ===================== إعادة تعيين الطنطيط =====================
  function resetBuzzer() {
    if (socket && socket.readyState === WebSocket.OPEN) {
      try {
        socket.send(JSON.stringify({
          type: 'buzz_reset'
        }));
      } catch(e) {
        console.error('فشل في إرسال reset:', e);
      }
    }
  }
  window.resetBuzzer = resetBuzzer;

  // ===================== بناء خلية الحروف =====================
  function createHoneycombCells(){
    const svg = document.getElementById('honeycombSvg');
    const positions = [
      {x:380,y:260,points:"250,200 380,140 510,200 510,320 380,380 250,320"},
      {x:630,y:260,points:"500,200 630,140 760,200 760,320 630,380 500,320"},
      {x:880,y:260,points:"750,200 880,140 1010,200 1010,320 880,380 750,320"},
      {x:1130,y:260,points:"1000,200 1130,140 1260,200 1260,320 1130,380 1000,320"},
      {x:1380,y:260,points:"1250,200 1380,140 1510,200 1510,320 1380,380 1250,320"},
      {x:505,y:440,points:"375,380 505,320 635,380 635,500 505,560 375,500"},
      {x:755,y:440,points:"625,380 755,320 885,380 885,500 755,560 625,500"},
      {x:1005,y:440,points:"875,380 1005,320 1135,380 1135,500 1005,560 875,500"},
      {x:1255,y:440,points:"1125,380 1255,320 1385,380 1385,500 1255,560 1125,500"},
      {x:1505,y:440,points:"1375,380 1505,320 1635,380 1635,500 1505,560 1375,500"},
      {x:380,y:620,points:"250,560 380,500 510,560 510,680 380,740 250,680"},
      {x:630,y:620,points:"500,560 630,500 760,560 760,680 630,740 500,680"},
      {x:880,y:620,points:"750,560 880,500 1010,560 1010,680 880,740 750,680"},
      {x:1130,y:620,points:"1000,560 1130,500 1260,560 1260,680 1130,740 1000,680"},
      {x:1380,y:620,points:"1250,560 1380,500 1510,560 1510,680 1380,740 1250,680"},
      {x:505,y:800,points:"375,740 505,680 635,740 635,860 505,920 375,860"},
      {x:755,y:800,points:"625,740 755,680 885,740 885,860 755,920 625,860"},
      {x:1005,y:800,points:"875,740 1005,680 1135,740 1135,860 1005,920 875,860"},
      {x:1255,y:800,points:"1125,740 1255,680 1385,740 1385,860 1255,920 1125,860"},
      {x:1505,y:800,points:"1375,740 1505,680 1635,740 1635,860 1505,920 1375,860"},
      {x:380,y:980,points:"250,920 380,860 510,920 510,1040 380,1100 250,1040"},
      {x:630,y:980,points:"500,920 630,860 760,920 760,1040 630,1100 500,1040"},
      {x:880,y:980,points:"750,920 880,860 1010,920 1010,1040 880,1100 750,1040"},
      {x:1130,y:980,points:"1000,920 1130,860 1260,920 1260,1040 1130,1100 1000,1040"},
      {x:1380,y:980,points:"1250,920 1380,860 1510,920 1510,1040 1380,1100 1250,1040"}
    ];

    for(let i=0;i<Math.min(25,lettersArr.length);i++){
      const letter   = lettersArr[i];
      const pos      = positions[i];

      const g   = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class','hex-cell');
      g.setAttribute('data-letter',letter);

      const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
      poly.setAttribute('class','hex-shape');
      poly.setAttribute('points',pos.points);

      const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('class','hex-text');
      txt.setAttribute('x',pos.x);
      txt.setAttribute('y',pos.y);
      txt.textContent = letter;

      g.appendChild(poly);
      g.appendChild(txt);
      svg.appendChild(g);

      // حدث النقر
      g.addEventListener('click', async () => {
        showQuestion(letter);

        if (lastClickedLetter === letter) {
          // دورة الألوان
          let newState = 'team1';
          if (g.classList.contains('team1')) {
            g.classList.remove('team1');
            g.classList.add('team2');
            newState = 'team2';
          } else if (g.classList.contains('team2')) {
            g.classList.remove('team2');
            newState = 'normal';
          } else {
            g.classList.add('team1');
            newState = 'team1';
          }
          cellStates[letter] = newState;

          // بثّ عبر WS
          sendWS({ type:'update_cell_state', letter, state:newState })
          .catch(() => updateCellStateAPI(letter, newState));
        }

        lastClickedLetter = letter;
      });
    }
  }

  // تحديث لون خلية على الواجهة
  function applyCellState(letter, state){
    const el = document.querySelector(`[data-letter="${letter}"]`);
    if (!el) return;
    el.classList.remove('team1','team2');
    if (state && state !== 'normal') { el.classList.add(state); }
    cellStates[letter] = state || 'normal';
  }

  // ===================== الأسئلة =====================
  async function showQuestion(letter){
    try{
      const r = await fetch(`/games/api/get-question/?session_id=${encodeURIComponent(sessionId)}&letter=${encodeURIComponent(letter)}`);
      if(!r.ok) return;
      const data = await r.json();
      const q = data.questions || {};
      document.getElementById('questionPanel').style.display = 'block';
      document.getElementById('currentLetter').textContent = data.letter || letter;
      document.getElementById('mainQuestion').textContent = (q.main && q.main.question) || 'لا يوجد سؤال';
      document.getElementById('mainAnswer').textContent   = (q.main && q.main.answer)   || '—';
      document.getElementById('alt1Question').textContent = (q.alt1 && q.alt1.question) || '—';
      document.getElementById('alt1Answer').textContent   = (q.alt1 && q.alt1.answer)   || '—';
      document.getElementById('alt2Question').textContent = (q.alt2 && q.alt2.question) || '—';
      document.getElementById('alt2Answer').textContent   = (q.alt2 && q.alt2.answer)   || '—';
      document.getElementById('questionDisplay').textContent = `حرف ${letter}`;
    }catch(e){}
  }

  // ===================== النقاط =====================
  function reflectScores(t1, t2){
    const m1 = document.getElementById('team1Score');
    const m2 = document.getElementById('team2Score');
    const d1 = document.getElementById('team1ScoreDesktop');
    const d2 = document.getElementById('team2ScoreDesktop');
    if (m1) m1.textContent = t1;
    if (m2) m2.textContent = t2;
    if (d1) d1.textContent = t1;
    if (d2) d2.textContent = t2;
  }

  async function updateScore(team, delta){
    const cur1 = parseInt(document.getElementById('team1ScoreDesktop').textContent || '0',10);
    const cur2 = parseInt(document.getElementById('team2ScoreDesktop').textContent || '0',10);
    let t1 = cur1, t2 = cur2;
    if (team === 'team1') t1 = Math.max(0, cur1 + delta);
    else                  t2 = Math.max(0, cur2 + delta);
    reflectScores(t1, t2);

    // WS أولاً ثم فولباك API
    sendWS({ type:'update_scores', team1_score:t1, team2_score:t2 })
    .catch(() => updateScoresAPI(t1, t2));
  }
  window.updateScore = updateScore;

  async function updateCellStateAPI(letter, state){
    try{
      await fetch('/games/api/update-cell-state/',{
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'X-Host-Token': hostToken },
        body: JSON.stringify({ session_id:sessionId, letter, state })
      });
    }catch(e){}
  }
  async function updateScoresAPI(team1, team2){
    try{
      await fetch('/games/api/update-scores/',{
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'X-Host-Token': hostToken },
        body: JSON.stringify({ session_id:sessionId, team1_score:team1, team2_score:team2 })
      });
    }catch(e){}
  }

  // ===================== إشعارات الطنطيط =====================
  function showBuzzNotification(contestantName, team, teamDisplay) {
    const notification = document.getElementById('buzzNotification');
    const teamName = team === 'team1' ? team1Name : team2Name;
    notification.innerHTML = `🚨 <strong>${contestantName}</strong><br>من ${teamName} ضغط الزر!`;
    notification.style.display = 'block';
    
    // صوت تنبيه
    playBuzzSound();
    
    // إخفاء بعد 4 ثواني
    setTimeout(() => {
      notification.style.display = 'none';
    }, 4000);
  }

  // ===================== تحميل حالة الجلسة =====================
  async function loadSessionState(){
    try{
      const r = await fetch(`/games/api/session-state/?session_id=${encodeURIComponent(sessionId)}`);
      if(!r.ok) return;
      const data = await r.json();

      reflectScores(data.team1_score||0, data.team2_score||0);

      if (data.cell_states){
        Object.entries(data.cell_states).forEach(([ltr, st]) => applyCellState(ltr, st));
      }

      if (typeof data.time_remaining_seconds === 'number'){
        startSessionTimer(data.time_remaining_seconds);
      }
    }catch(e){}
  }

  // ===================== مؤقّت الجلسة =====================
  let sessionTimerInterval = null;
  function startSessionTimer(seconds){
    const el = document.getElementById('timeRemaining');
    const box = document.getElementById('sessionTimer');
    if(!el || !box) return;
    if (sessionTimerInterval) clearInterval(sessionTimerInterval);

    let left = Math.max(0, parseInt(seconds,10) || 0);
    const render = () => {
      const m = Math.floor(left / 60);
      const s = left % 60;
      el.textContent = `${m}:${String(s).padStart(2,'0')}`;
      if (left <= 0){
        clearInterval(sessionTimerInterval);
        el.textContent = '0:00';
      }
    };
    render();
    sessionTimerInterval = setInterval(() => { left = Math.max(0,left-1); render(); }, 1000);
  }

  // ===================== WebSocket محسّن =====================
  function setupWebSocket(){
    const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
    const url   = `${proto}://${location.host}/ws/letters/${encodeURIComponent(sessionId)}/?role=host&host_token=${encodeURIComponent(hostToken)}`;

    socket = new WebSocket(url);

    socket.onopen = () => {
      console.log('🟢 WebSocket متصل - المقدم');
      reconnectDelay = 1000;
    };

    socket.onmessage = (ev) => {
      let d = {};
      try{ d = JSON.parse(ev.data || '{}'); }catch{}

      switch(d.type){
        case 'contestant_buzz_accepted':
          // إشعار فوري للمقدم فقط
          showBuzzNotification(d.contestant_name, d.team, d.team_display);
          break;

        case 'cell_state_updated':
          applyCellState(d.letter, d.state);
          break;

        case 'scores_updated':
          reflectScores(d.team1_score, d.team2_score);
          break;

        case 'pong':
          break;

        default: 
          break;
      }
    };

    socket.onclose = () => {
      console.log('🔴 WebSocket انقطع - إعادة المحاولة...');
      setTimeout(setupWebSocket, reconnectDelay);
      reconnectDelay = Math.min(reconnectDelay*2, maxDelay);
    };

    socket.onerror = () => {
      try{ socket.close(); }catch{}
    };
  }

  function sendWS(payload){
    return new Promise((resolve, reject) => {
      if (socket && socket.readyState === WebSocket.OPEN){
        try{ socket.send(JSON.stringify(payload)); resolve(); }
        catch(e){ reject(e); }
      } else {
        reject(new Error('ws not open'));
      }
    });
  }

  // ===================== تهيئة الصفحة =====================
  window.addEventListener('beforeunload', () => {
    try{ socket && socket.readyState === WebSocket.OPEN && socket.close(1000,'page unload'); }catch{}
  });

  document.addEventListener('DOMContentLoaded', () => {
    createHoneycombCells();
    loadSessionState();
    setupWebSocket();
    setInterval(loadSessionState, 30000); // تحديث أقل تكراراً
  });
</script>

</body>
</html>