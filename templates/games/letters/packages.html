{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>اختر الحزمة — خلية الحروف</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@emran-alhaddad/saudi-riyal-font/index.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#667eea; --bg2:#764ba2;
      --cardBorder: rgba(139,92,246,.14);
      --mixBg:#e0e7ff; --mixText:#4338ca; --mixBorder:#a5b4fc;
      --sprBg:#dcfce7; --sprText:#166534; --sprBorder:#86efac;
      --ok:#22c55e; --primary:#8b5cf6; --cyan:#06b6d4;
      --muted:#64748b; --ink:#1f2937;
    }
    body{background:linear-gradient(135deg,var(--bg1),var(--bg2));font-family:'Tajawal',sans-serif}
    .packages-section{background:#fff; border-radius:24px; margin:24px auto; padding:32px 16px; max-width:1200px}

    .section-title h2{
      font-size:2rem;font-weight:900;margin:0;
      background:linear-gradient(135deg,var(--primary),var(--cyan));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }
    .section-title p{color:#475569}

    .scroll-row{display:flex; gap:16px; overflow-x:auto; padding-bottom:8px}
    .scroll-row::-webkit-scrollbar{height:10px}
    .scroll-row::-webkit-scrollbar-thumb{background:#c7d2fe;border-radius:999px}
    .scroll-row::-webkit-scrollbar-track{background:#eef2ff;border-radius:999px}

    .pkg{min-width:280px; max-width:320px; flex:0 0 auto}
    .cardx{
      background:#fff;border:1px solid var(--cardBorder);border-radius:18px;padding:16px;position:relative;
      box-shadow:0 14px 32px rgba(0,0,0,.08);height:100%;
    }
    .cardx.free{border:2px dashed var(--ok); background:linear-gradient(180deg,#f0fdf4, #fff 60%)}
    .ribbon{position:absolute; top:10px; left:-8px; background:var(--ok); color:#fff; padding:6px 12px;
      border-radius:0 10px 10px 0; font-weight:900; box-shadow:0 6px 16px rgba(34,197,94,.35)}
    .used-before{position:absolute; top:10px; right:10px; background:#fff7ed; color:#9a3412; border:1px solid #fed7aa;
      padding:6px 10px; border-radius:10px; font-weight:800; font-size:.8rem; display:flex; gap:6px; align-items:center}

    .title{font-weight:900; font-size:1.1rem; text-align:center}
    .badge-mix{background:var(--mixBg); color:var(--mixText); border:1px solid var(--mixBorder); border-radius:999px; padding:.25rem .6rem; font-weight:800}
    .badge-spr{background:var(--sprBg); color:var(--sprText); border:1px solid var(--sprBorder); border-radius:999px; padding:.25rem .6rem; font-weight:800}

    .btn-play{
      display:block; width:100%; text-align:center; color:#fff; font-weight:900; border:none;
      background:linear-gradient(135deg,var(--primary),var(--cyan)); border-radius:14px; padding:10px; text-decoration:none;
    }
    .btn-play:hover{color:#fff; box-shadow:0 10px 20px rgba(139,92,246,.25)}
  </style>
</head>
<body>

  {% include 'header.html' %}

  <div class="container my-3">
    {% if messages %}
      {% for m in messages %}
        <div class="alert alert-{{ m.tags|default:'info' }}">{{ m|safe }}</div>
      {% endfor %}
    {% endif %}
  </div>

  <!-- فورم إنشاء جلسة (مخفي) -->
  <form id="lettersCreateForm" method="post" action="{% url 'games:create_letters_session' %}" style="display:none">
    {% csrf_token %}
    <input type="hidden" name="package_id" id="lettersPkgId">
    <button type="submit" id="hiddenSubmitBtn">go</button>
  </form>

  <section class="packages-section">
    <div class="section-title text-center mb-3">
      <h2>اختر الحزمة المناسبة</h2>
      <p>ابدأ التحدي الآن واختر إحدى الحزم التالية للعب خلية الحروف</p>
    </div>

    <!-- المجانية بالأعلى -->
    {% if free_package %}
      <div class="pkg mb-3" style="min-width:100%;">
        <div class="cardx free">
          <span class="ribbon">مجانية</span>
          <div class="title mb-2">جولة تجريبية</div>
          <div class="text-center mb-2">
            {% if free_package.question_theme == 'sports' %}
              <span class="badge-spr">نوع الأسئلة: {{ free_package.get_question_theme_display }}</span>
            {% else %}
              <span class="badge-mix">نوع الأسئلة: {{ free_package.get_question_theme_display }}</span>
            {% endif %}
          </div>

          <div>
            {% if request.user.is_authenticated %}
              {% if free_active_session %}
                <a class="btn-play" href="{% url 'games:letters_session' free_active_session.id %}" target="_blank" rel="noopener">ارجع إلى جلستك المجانية</a>
              {% elif free_session_eligible %}
                <button class="btn-play" type="button" onclick="createLettersSession('{{ free_package.id }}')">ابدأ الجولة المجانية</button>
              {% else %}
                <button class="btn btn-secondary w-100" disabled>غير متاح</button>
                <div class="text-center text-warning small mt-2">{{ free_session_message }}</div>
              {% endif %}
            {% else %}
              <a class="btn btn-outline-primary w-100" href="{% url 'accounts:login' %}?next={{ request.get_full_path|urlencode }}">سجّل الدخول للتجربة</a>
            {% endif %}
          </div>
        </div>
      </div>
    {% endif %}

    <!-- منوّعة -->
    {% if paid_packages_mixed %}
      <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
        <h5 class="m-0 fw-bold">🧩 أسئلة منوّعة</h5>
        <small class="text-muted">ترتيب حسب رقم الحزمة</small>
      </div>
      <div class="scroll-row" role="region" aria-label="حزم منوّعة">
        {% for package in paid_packages_mixed %}
          <div class="pkg">
            <div class="cardx">
              {% if used_before_ids and package.id in used_before_ids %}
                <div class="used-before"><i class="fa-solid fa-rotate-left"></i> سبق لك لعب هذه الحزمة</div>
              {% endif %}

              <div class="title">حزمة رقم {{ package.package_number }}</div>
              <div class="text-center my-2">
                <span class="badge-mix">نوع الأسئلة: {{ package.get_question_theme_display }}</span>
              </div>

              <div class="mt-3">
                {% if user_purchases and package.id in user_purchases %}
                  <!-- شراء صالح خلال 72 ساعة => ابدأ اللعب -->
                  <a class="btn-play" href="{% url 'games:create_letters_session' %}?package_id={{ package.id }}" target="_blank" rel="noopener">ابدأ اللعب</a>
                {% else %}
                  <!-- دائمًا اسمح بالشراء -->
                  <a class="btn-play" href="{% url 'payments:purchase' package.id %}">شراء</a>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- رياضية -->
    {% if paid_packages_sports %}
      <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
        <h5 class="m-0 fw-bold">🏅 أسئلة رياضية</h5>
        <small class="text-muted">ترتيب حسب رقم الحزمة</small>
      </div>
      <div class="scroll-row" role="region" aria-label="حزم رياضية">
        {% for package in paid_packages_sports %}
          <div class="pkg">
            <div class="cardx">
              {% if used_before_ids and package.id in used_before_ids %}
                <div class="used-before"><i class="fa-solid fa-rotate-left"></i> سبق لك لعب هذه الحزمة</div>
              {% endif %}

              <div class="title">حزمة رقم {{ package.package_number }}</div>
              <div class="text-center my-2">
                <span class="badge-spr">نوع الأسئلة: {{ package.get_question_theme_display }}</span>
              </div>

              <div class="mt-3">
                {% if user_purchases and package.id in user_purchases %}
                  <a class="btn-play" href="{% url 'games:create_letters_session' %}?package_id={{ package.id }}" target="_blank" rel="noopener">ابدأ اللعب</a>
                {% else %}
                  <a class="btn-play" href="{% url 'payments:purchase' package.id %}">شراء</a>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </section>

  {% include 'footer.html' %}

  <script>
    // إنشاء جلسة عبر POST (لمنع مشاكل CSRF على الأزرار)
    function createLettersSession(pkgId){
      const f = document.getElementById('lettersCreateForm');
      document.getElementById('lettersPkgId').value = pkgId;
      f.submit();
    }
  </script>
</body>
</html>
