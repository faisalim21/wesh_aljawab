<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>{% block title %}{{ page_title|default:"وش الجواب - خلية الحروف" }}{% endblock %}</title>
  <meta name="description" content="{% block meta_description %}{{ page_description|default:'اختبر ذكاءك وتحدى أصدقاءك مع منصة وش الجواب للألعاب الذكية التفاعلية.' }}{% endblock %}">
  <meta name="robots" content="index,follow">
  <link rel="canonical" href="{% if request %}{{ request.build_absolute_uri }}{% else %}https://wesh-aljawab.onrender.com/{% endif %}">

  <meta property="og:locale" content="ar_SA">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="وش الجواب">
  <meta property="og:title" content="{% block og_title %}{{ page_title|default:'وش الجواب - منصة الألعاب الذكية' }}{% endblock %}">
  <meta property="og:description" content="{% block og_description %}{{ page_description|default:'اختبر ذكاءك وتحدى أصدقاءك مع منصة وش الجواب للألعاب الذكية التفاعلية.' }}{% endblock %}">
  <meta property="og:url" content="{% if request %}{{ request.build_absolute_uri }}{% else %}https://wesh-aljawab.onrender.com/{% endif %}">
  <meta property="og:image" content="{% firstof page_og_image 'https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png' %}">
  <meta property="og:image:secure_url" content="{% firstof page_og_image 'https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png' %}">
  <meta property="og:image:alt" content="{% block og_image_alt %}{{ page_og_alt|default:'شعار وش الجواب' }}{% endblock %}">

  <meta name="theme-color" content="#4f46e5">
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png">
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@emran-alhaddad/saudi-riyal-font/index.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#667eea; --bg2:#764ba2;
      --cardBorder: rgba(139,92,246,.14);
      --mixBg:#e0e7ff; --mixText:#4338ca; --mixBorder:#a5b4fc;
      --sprBg:#dcfce7; --sprText:#166534; --sprBorder:#86efac;
      --ok:#22c55e; --primary:#8b5cf6; --cyan:#06b6d4;
      --muted:#64748b; --ink:#1f2937;
    }
    body{background:linear-gradient(135deg,var(--bg1),var(--bg2));font-family:'Tajawal',sans-serif;}
    .packages-section{background:#fff;padding:56px 0}
    .section-title{text-align:center;margin-bottom:24px}
    .section-title h2{font-weight:800;font-size:2rem;background:linear-gradient(135deg,var(--primary),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .scroll-row{display:flex;gap:16px;overflow-x:auto;padding-bottom:8px;scrollbar-width:thin}
    .scroll-row::-webkit-scrollbar{height:10px}
    .scroll-row::-webkit-scrollbar-thumb{background:#c7d2fe;border-radius:999px}
    .scroll-row::-webkit-scrollbar-track{background:#eef2ff;border-radius:999px}
    .pkg-col{flex:0 0 85%;max-width:85%}
    @media(min-width:576px){.pkg-col{flex:0 0 48%;max-width:48%}}
    @media(min-width:992px){.pkg-col{flex:0 0 31%;max-width:31%}}
    .package-card{border:1px solid var(--cardBorder);border-radius:18px;padding:16px;box-shadow:0 18px 38px rgba(0,0,0,.08);height:100%;position:relative}
    .package-card:hover{transform:translateY(-4px);transition:.2s}
    .package-title{font-weight:800;text-align:center}
    .theme-badge{display:inline-block;padding:.25rem .6rem;border-radius:999px;font-size:.8rem;font-weight:800}
    .theme-mixed{background:var(--mixBg);color:var(--mixText);border:1px solid var(--mixBorder)}
    .theme-sports{background:var(--sprBg);color:var(--sprText);border:1px solid var(--sprBorder)}
    .free-card{border:2px dashed var(--ok);background:linear-gradient(180deg,#f0fdf4 0%,#ffffff 60%);box-shadow:0 14px 28px rgba(34,197,94,.14)}
    .free-ribbon{position:absolute;top:10px;left:-8px;background:var(--ok);color:#fff;padding:6px 12px;border-radius:0 10px 10px 0;font-weight:900;font-size:.9rem;box-shadow:0 6px 16px rgba(34,197,94,.35)}
    .btn-play{display:block;width:100%;background:linear-gradient(135deg,var(--primary),var(--cyan));color:#fff;padding:11px;border:none;border-radius:14px;font-weight:800;text-align:center;text-decoration:none}
    .btn-play:hover{color:#fff;box-shadow:0 10px 20px rgba(139,92,246,.25)}
    .used-before{position:absolute;top:10px;right:10px;background:#fff7ed;color:#9a3412;border:1px solid #fed7aa;padding:6px 10px;border-radius:10px;font-weight:800;font-size:.8rem;display:flex;gap:6px}
    .subsection-title{display:flex;align-items:center;justify-content:space-between;margin:24px 0 12px}
  </style>
</head>
<body>

{% include 'header.html' %}

<div class="container pt-4">
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} mb-2">{{ message|safe }}</div>
      {% endfor %}
    </div>
  {% endif %}
</div>

<!-- ✅ فورم مخفي يفتح الجلسة في تبويب جديد -->
<form id="lettersCreateForm" method="post" action="{% url 'games:create_letters_session' %}" target="_blank" style="display:none">
  {% csrf_token %}
  <input type="hidden" name="package_id" id="lettersPkgId">
  <button type="submit" id="hiddenSubmitBtn" style="display:none">Submit</button>
</form>

<section class="packages-section">
  <div class="container">
    <div class="section-title">
      <h2>اختر الحزمة المناسبة</h2>
      <p>ابدأ التحدي الآن واختر إحدى الحزم التالية للعب خلية الحروف</p>
    </div>

    <div class="row g-3 mb-3">
      {% if free_package %}
        <div class="col-12">
          <div class="package-card free-card">
            <div class="free-ribbon">مجانية</div>
            <div class="package-title mb-1">جولة تجريبية</div>

            <div class="text-center mb-2">
              {% if free_package.question_theme == 'sports' %}
                <span class="theme-badge theme-sports">نوع الأسئلة: {{ free_package.get_question_theme_display }}</span>
              {% else %}
                <span class="theme-badge theme-mixed">نوع الأسئلة: {{ free_package.get_question_theme_display }}</span>
              {% endif %}
            </div>

            <div>
              {% if request.user.is_authenticated %}
                {% if free_active_session %}
                  <a href="{% url 'games:letters_session' free_active_session.id %}" class="btn-play">ارجع إلى جلستك المجانية</a>
                {% elif free_session_eligible %}
                  <button type="button" class="btn-play" onclick="createLettersSession('{{ free_package.id }}')">ابدأ الجولة المجانية</button>
                {% else %}
                  <button type="button" class="btn btn-secondary w-100" disabled>غير متاح</button>
                  <div class="text-center mt-2 text-muted">{{ free_session_message|default:"لقد استخدمت الجلسة المجانية الخاصة بك." }}</div>
                {% endif %}
              {% else %}
                <a class="btn btn-outline-primary w-100" href="{% url 'accounts:login' %}?next={{ request.get_full_path|urlencode }}">سجّل الدخول للتجربة</a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
    </div>

    {% if paid_packages_mixed %}
      <div class="subsection-title">
        <h5 class="m-0">🧩 أسئلة منوعة</h5>
        <small class="text-muted">ترتيب حسب رقم الحزمة</small>
      </div>
      <div class="scroll-row" role="region" aria-label="حزم الأسئلة المنوعة">
        {% for package in paid_packages_mixed %}
          <div class="pkg-col">
            <div class="package-card">
              {% if used_before_ids and package.id in used_before_ids %}
                <div class="used-before"><i class="fa-solid fa-rotate-left"></i> سبق لك لعب هذه الحزمة</div>
              {% endif %}

              <div class="package-title">حزمة رقم {{ package.package_number }}</div>
              <div class="text-center my-2">
                <span class="theme-badge theme-mixed">نوع الأسئلة: {{ package.get_question_theme_display }}</span>
              </div>

              <div class="text-center mb-2">
                {% if package.has_discount %}
                  <div><strong class="text-info">{{ package.discounted_price|floatformat:0 }}</strong> <span class="icon-saudi_riyal"></span>
                    <del class="text-muted ms-2">{{ package.original_price|floatformat:0 }}</del>
                  </div>
                {% else %}
                  <div><strong>{{ package.price|floatformat:0 }}</strong> <span class="icon-saudi_riyal"></span></div>
                {% endif %}
              </div>

              {% if user_purchases and package.id in user_purchases %}
                <button type="button" class="btn-play" onclick="createLettersSession('{{ package.id }}')">ابدأ اللعب</button>
              {% else %}
                <a class="btn-play purchase-link"
                   href="{% url 'payments:purchase' package.id %}"
                   data-package-id="{{ package.id }}"
                   data-used-before="{% if used_before_ids and package.id in used_before_ids %}true{% else %}false{% endif %}">
                  شراء
                </a>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% if paid_packages_sports %}
      <div class="subsection-title mt-4">
        <h5 class="m-0">🏅 أسئلة رياضية</h5>
        <small class="text-muted">ترتيب حسب رقم الحزمة</small>
      </div>
      <div class="scroll-row" role="region" aria-label="حزم الأسئلة الرياضية">
        {% for package in paid_packages_sports %}
          <div class="pkg-col">
            <div class="package-card">
              {% if used_before_ids and package.id in used_before_ids %}
                <div class="used-before"><i class="fa-solid fa-rotate-left"></i> سبق لك لعب هذه الحزمة</div>
              {% endif %}

              <div class="package-title">حزمة رقم {{ package.package_number }}</div>
              <div class="text-center my-2">
                <span class="theme-badge theme-sports">نوع الأسئلة: {{ package.get_question_theme_display }}</span>
              </div>

              <div class="text-center mb-2">
                {% if package.has_discount %}
                  <div><strong class="text-info">{{ package.discounted_price|floatformat:0 }}</strong> <span class="icon-saudi_riyal"></span>
                    <del class="text-muted ms-2">{{ package.original_price|floatformat:0 }}</del>
                  </div>
                {% else %}
                  <div><strong>{{ package.price|floatformat:0 }}</strong> <span class="icon-saudi_riyal"></span></div>
                {% endif %}
              </div>

              {% if user_purchases and package.id in user_purchases %}
                <button type="button" class="btn-play" onclick="createLettersSession('{{ package.id }}')">ابدأ اللعب</button>
              {% else %}
                <a class="btn-play purchase-link"
                   href="{% url 'payments:purchase' package.id %}"
                   data-package-id="{{ package.id }}"
                   data-used-before="{% if used_before_ids and package.id in used_before_ids %}true{% else %}false{% endif %}">
                  شراء
                </a>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

  </div>
</section>

{% include 'footer.html' %}

<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const IS_AUTH = {{ request.user.is_authenticated|yesno:"true,false" }};
    const LOGIN_URL = "{% url 'accounts:login' %}";
    const NEXT_URL = "{{ request.get_full_path|urlencode }}";

    // تأكيد بسيط عند شراء حزمة سبق لعبها
    document.querySelectorAll('.purchase-link[data-used-before="true"]').forEach(a=>{
      a.addEventListener('click', (ev)=>{
        const ok = confirm('تنبيه: سبق لك لعب هذه الحزمة.\nإذا رغبت باللعب مرة أخرى، أكمل عملية الشراء.');
        if (!ok){ ev.preventDefault(); }
      });
    });

    // إرسال إنشاء جلسة (يفتح في تبويب جديد لأن الفورم target="_blank")
    window.createLettersSession = function(packageId) {
      if (!IS_AUTH) {
        window.location.href = `${LOGIN_URL}?next=${encodeURIComponent(NEXT_URL)}`;
        return;
      }
      const form = document.getElementById('lettersCreateForm');
      const input = document.getElementById('lettersPkgId');
      const submitBtn = document.getElementById('hiddenSubmitBtn');
      input.value = packageId;
      submitBtn ? submitBtn.click() : form.submit();
    };
  });
</script>
</body>
</html>
