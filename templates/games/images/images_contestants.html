<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <meta name="theme-color" content="#7c3aed" />

  <title>{% block title %}{{ page_title|default:"ÙˆØ´ Ø§Ù„Ø¬ÙˆØ§Ø¨ - ØµÙØ­Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ (ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„ØµÙˆØ±)" }}{% endblock %}</title>

  <!-- Social + SEO (Ù…Ø®ØªØµØ±) -->
  <meta name="description" content="{% block meta_description %}{{ page_description|default:'ØµÙØ­Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ Ù„ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„ØµÙˆØ± Ù…Ù† ÙˆØ´ Ø§Ù„Ø¬ÙˆØ§Ø¨.' }}{% endblock %}">
  <link rel="canonical" href="{% if request %}{{ request.build_absolute_uri }}{% else %}https://wesh-aljawab.onrender.com/{% endif %}">
  <meta property="og:site_name" content="ÙˆØ´ Ø§Ù„Ø¬ÙˆØ§Ø¨">
  <meta property="og:title" content="{% block og_title %}{{ page_title|default:'ÙˆØ´ Ø§Ù„Ø¬ÙˆØ§Ø¨ - ØµÙØ­Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ (ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„ØµÙˆØ±)' }}{% endblock %}">
  <meta property="og:description" content="{% block og_description %}{{ page_description|default:'ØµÙØ­Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ Ù„ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„ØµÙˆØ± Ù…Ù† ÙˆØ´ Ø§Ù„Ø¬ÙˆØ§Ø¨.' }}{% endblock %}">
  <meta property="og:image" content="{% firstof page_og_image 'https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png' %}">
  <meta name="twitter:card" content="summary_large_image">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg1:#c084fc;--bg2:#7c3aed;--bg3:#5b21b6;
      --white:#fff; --glass:rgba(255,255,255,.1); --glass-b:rgba(255,255,255,.2);
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --gray:#94a3b8;
      --btn1:#ef4444; --btn2:#dc2626; --btn3:#b91c1c;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; padding:0;
      font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--white);
      background:
        radial-gradient(1200px 600px at 70% -20%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 55%, var(--bg3) 100%);
      overflow-x:hidden;
    }

    /* Ø´ÙØ¹Ø§Ø± */
    .logo{
      position: fixed; top: env(safe-area-inset-top, 12px); right: 12px;
      background: rgba(255,255,255,.95);
      padding: 8px 12px; border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25); z-index: 10;
    }
    .logo img{ max-height: 46px; display:block }

    /* Ù„Ù…Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„ */
    .conn{
      position: fixed; top: calc(env(safe-area-inset-top, 12px) + 8px); left: 12px; z-index: 10;
      padding: 8px 12px; border-radius: 999px; font-weight:800; font-size:.85rem;
    }
    .conn.connected{ background: rgba(34,197,94,.92) }    /* ÙƒÙ„Ø§ Ø§Ù„Ù‚Ù†Ø§ØªÙŠÙ† Ù…ØªØµÙ„ */
    .conn.partial{ background: rgba(245,158,11,.92) }     /* Ù‚Ù†Ø§Ø© ÙˆØ§Ø­Ø¯Ø© Ù…ØªØµÙ„Ø© */
    .conn.disconnected{ background: rgba(239,68,68,.92); animation: blink 1s infinite }
    @keyframes blink{ 0%,50%{opacity:1} 51%,100%{opacity:.6} }

    .main{
      min-height:100dvh; display:flex; align-items:center; justify-content:center;
      padding: clamp(12px, 3vw, 28px);
    }
    .card-ct{
      width: min(720px, 96vw);
      background: var(--glass);
      border: 1px solid var(--glass-b);
      border-radius: 24px;
      padding: clamp(18px, 3.2vw, 34px);
      backdrop-filter: blur(18px);
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
      text-align:center;
    }
    .title h1{
      font-size: clamp(1.6rem, 5.5vw, 2.2rem);
      margin:0; font-weight:900; letter-spacing:.3px;
      background: linear-gradient(45deg, #fbbf24, #f59e0b, #d97706);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
    }
    .subtitle{ color:#e2e8f0; margin-top: 6px; font-size:.95rem }

    /* Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© */
    .frame{
      margin: 14px 0 10px;
      background: rgba(0,0,0,.65);
      border: 1px solid rgba(255,255,255,.25);
      border-radius: 18px;
      width: 100%; min-height: clamp(180px, 38vh, 420px);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      box-shadow: 0 14px 34px rgba(0,0,0,.3);
    }
    .frame img{ max-width:100%; max-height:70vh; display:block }

    /* Ù†Ù‚Ø§Ø· Ù…Ø®ØªØµØ±Ø© */
    .scores{
      display:flex; gap:8px; justify-content:center; margin-bottom: 6px; flex-wrap:wrap;
    }
    .score{
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.3);
      border-radius: 12px;
      padding: 6px 10px; font-weight:900;
    }
    .score .nm{ opacity:.9; font-size:.9rem }
    .score .val{ font-size:1.3rem }

    /* Ø§Ù„Ø­Ù‚ÙˆÙ„ */
    .name-input{
      width:100%; margin: 10px 0 12px;
      background: rgba(255,255,255,.96); color:#1f2937;
      border: 2px solid rgba(255,255,255,.45); border-radius: 14px;
      padding: 12px 14px; font-weight:800; font-size:1.05rem; text-align:center;
      transition:.2s ease;
    }
    .name-input:focus{
      outline:none; border-color:#8b5cf6; box-shadow:0 0 0 4px rgba(139,92,246,.22);
      transform: scale(1.01);
    }
    .teams{ margin: 6px 0 12px }
    .teams label.h{ display:block; font-weight:800; margin-bottom:8px; color:#e2e8f0 }
    .team-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .topt{ position:relative }
    .topt input{ position:absolute; inset:0; opacity:0 }
    .tbtn{
      display:flex; align-items:center; justify-content:center;
      min-height:52px; padding: 10px 8px;
      border-radius: 14px; font-weight:800; font-size:1rem;
      border:2px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.1);
      transition:.2s ease; user-select:none;
    }
    .topt input:checked + .tbtn.team1{
      border-color:#22c55e; color:#22c55e;
      background: linear-gradient(135deg, rgba(34,197,94,.25), rgba(34,197,94,.08));
      box-shadow: 0 10px 25px rgba(34,197,94,.25);
    }
    .topt input:checked + .tbtn.team2{
      border-color:#f97316; color:#f97316;
      background: linear-gradient(135deg, rgba(249,115,22,.25), rgba(249,115,22,.08));
      box-shadow: 0 10px 25px rgba(249,115,22,.25);
    }

    /* Ø²Ø± Ø§Ù„Ø·Ù†Ø·ÙŠØ· */
    .buzz-wrap{ margin-top: 8px }
    .buzz-btn{
      --size: clamp(120px, 34vw, 170px);
      width: var(--size); height: var(--size);
      margin-inline:auto; border-radius: 999px; position: relative; border: 0; cursor: pointer;
      display: grid; place-items:center; font-weight: 900; letter-spacing:.4px;
      font-size: clamp(1.15rem, 4.2vw, 1.6rem); color:#fff; outline: none;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
      background:
        radial-gradient(140% 60% at 50% 8%, rgba(255,255,255,.35), transparent 40%),
        linear-gradient(165deg, var(--btn1) 0%, var(--btn2) 45%, var(--btn3) 100%);
      box-shadow: 0 18px 35px rgba(239,68,68,.45), inset 0 -10px 18px rgba(0,0,0,.25), inset 0 8px 12px rgba(255,255,255,.08);
      isolation:isolate;
    }
    .buzz-btn::before{
      content:""; position:absolute; inset:0; border-radius:inherit;
      background: linear-gradient(180deg, rgba(255,255,255,.45), transparent 35% 90%, rgba(0,0,0,.25));
      mix-blend-mode: soft-light; pointer-events:none;
    }
    .buzz-btn::after{
      content:""; position:absolute; top:6%; left:16%; width:68%; height:18%;
      border-radius:999px; background: linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.15));
      filter: blur(1px); transform: rotate(-6deg); pointer-events:none;
    }
    .buzz-btn.wave > i{
      content:""; position:absolute; inset:0; border-radius:inherit;
      animation: wave .6s ease-out forwards;
      background: radial-gradient(circle, rgba(255,255,255,.55) 0%, rgba(255,255,255,0) 60%);
      mix-blend-mode: screen; pointer-events:none;
    }
    @keyframes wave{ from{ transform: scale(.1); opacity:1 } to{ transform: scale(2.2); opacity:0 } }
    .buzz-btn:hover{ transform: translateY(-2px) scale(1.03) }
    .buzz-btn:active:not(:disabled){ transform: translateY(1px) scale(.97); filter: saturate(1.1) }
    .buzz-btn:disabled{
      background: linear-gradient(165deg, #6b7280, #4b5563);
      box-shadow: 0 10px 20px rgba(0,0,0,.25), inset 0 -10px 18px rgba(0,0,0,.2);
      cursor:not-allowed;
    }
    .buzz-label{ position:relative; z-index:2; text-shadow: 0 2px 0 rgba(0,0,0,.2) }

    /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø§Ù„Ø© */
    .status{
      margin-top: 14px; display:none;
      border-radius: 14px; padding: 12px 14px; font-weight:800; text-align:center;
    }
    .status.show{ display:block }
    .status.ok{ background: rgba(34,197,94,.2); border:1px solid var(--ok); color: var(--ok); animation: pulse .4s ease }
    .status.err{ background: rgba(239,68,68,.2); border:1px solid var(--err); color: var(--err); animation: shake .38s ease }
    .status.info{ background: rgba(59,130,246,.2); border:1px solid #3b82f6; color:#3b82f6 }
    @keyframes pulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.02)} }
    @keyframes shake{ 0%,100%{ transform:translateX(0) } 25%{ transform:translateX(-6px) } 75%{ transform:translateX(6px) } }

    @media (max-width: 768px){
      .card-ct{ padding: 20px 16px; border-radius: 20px }
      .logo{ right:10px; top:10px }
      .frame{ min-height: 200px }
    }
  </style>
</head>
<body>

  <!-- Ù„Ù…Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
  <div id="conn" class="conn disconnected">ğŸ”´ Ù…Ù†Ù‚Ø·Ø¹</div>

  <!-- Ø§Ù„Ø´Ø¹Ø§Ø± -->
  <div class="logo">
    <img src="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png" alt="ÙˆØ´ Ø§Ù„Ø¬ÙˆØ§Ø¨" />
  </div>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
  <main class="main">
    <section class="card-ct" aria-labelledby="title">
      <div class="title" id="title">
        <h1>ğŸ¤ ØµÙØ­Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ â€” ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„ØµÙˆØ±</h1>
        <div class="subtitle">
          {{ session.package.get_game_type_display }} â€” Ø­Ø²Ù…Ø© {{ session.package.package_number }}
        </div>
      </div>

      <!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…ØªØ²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ù…Ù‚Ø¯Ù…) -->
      <div class="frame">
        <img id="puzzleImg" src="" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØºØ²" />
      </div>

      <!-- Ù†Ù‚Ø§Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ø¹Ø±Ø¶) -->
      <div class="scores">
        <div class="score">
          <div class="nm">ğŸŸ¢ {{ session.team1_name }}</div>
          <div class="val" id="t1">0</div>
        </div>
        <div class="score">
          <div class="nm">ğŸŸ  {{ session.team2_name }}</div>
          <div class="val" id="t2">0</div>
        </div>
      </div>

      <!-- Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙØ±ÙŠÙ‚ -->
      <input id="name" class="name-input" type="text" inputmode="text" maxlength="20"
             placeholder="ğŸ·ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" autocomplete="off" aria-label="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚" />

      <div class="teams">
        <label class="h">Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ:</label>
        <div class="team-grid">
          <label class="topt">
            <input id="t1r" type="radio" name="team" value="team1" />
            <div class="tbtn team1">ğŸŸ¢ {{ session.team1_name }}</div>
          </label>
          <label class="topt">
            <input id="t2r" type="radio" name="team" value="team2" />
            <div class="tbtn team2">ğŸŸ  {{ session.team2_name }}</div>
          </label>
        </div>
      </div>

      <!-- Ø²Ø± Ø§Ù„Ø·Ù†Ø·ÙŠØ· -->
      <div class="buzz-wrap">
        <button id="buzz" class="buzz-btn" type="button" aria-live="polite" aria-label="Ø§Ø¶ØºØ· Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø©">
          <span class="buzz-label" id="buzzText">Ø¬Ø§ÙˆÙØ¨!</span>
        </button>
      </div>

      <!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø§Ù„Ø© -->
      <div id="status" class="status" role="status" aria-live="polite"></div>
    </section>
  </main>

  <script>
    // ======== Ø«ÙˆØ§Ø¨Øª Ø¹Ø§Ù…Ø© ========
    const sessionId = '{{ session.id }}';
    const LS_NAME_KEY = `wjg_img_name_${sessionId}`;
    const LS_TEAM_KEY = `wjg_img_team_${sessionId}`;

    // Ù‚Ù†Ø§ØªØ§Ù†: (1) Ù‚Ù†Ø§Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ (2) Ù‚Ù†Ø§Ø© Ø¹Ø±Ø¶/Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù†Ù‚Ø§Ø·
    let wsContest = null;   // role=contestant
    let wsFeed = null;      // role=display (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)
    let d1 = 1000, d2 = 1000;          // backoff
    const MAX_DELAY = 5000;
    let hb1 = null, hb2 = null;

    // ======== Ø¹Ù†Ø§ØµØ± ========
    const el = {
      conn: document.getElementById('conn'),
      img:  document.getElementById('puzzleImg'),
      name: document.getElementById('name'),
      t1r:  document.getElementById('t1r'),
      t2r:  document.getElementById('t2r'),
      buzz: document.getElementById('buzz'),
      status: document.getElementById('status'),
      buzzText: document.getElementById('buzzText'),
      s1: document.getElementById('t1'),
      s2: document.getElementById('t2'),
    };

    // ======== Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ø¬Ù‡Ø© ========
    function setConn(){
      const c1 = wsContest && wsContest.readyState === 1;
      const c2 = wsFeed && wsFeed.readyState === 1;
      el.conn.className = 'conn ' + (c1 && c2 ? 'connected' : (c1 || c2 ? 'partial' : 'disconnected'));
      el.conn.textContent = c1 && c2 ? 'ğŸŸ¢ Ù…ØªØµÙ„' : (c1 || c2 ? 'ğŸŸ¡ Ø§ØªØµØ§Ù„ Ø¬Ø²Ø¦ÙŠ' : 'ğŸ”´ Ù…Ù†Ù‚Ø·Ø¹');
    }
    function showMsg(kind, text, autoHideMs){
      el.status.className = 'status show ' + (kind||'info');
      el.status.textContent = text || '';
      if (autoHideMs){ setTimeout(()=>{ el.status.classList.remove('show'); }, autoHideMs); }
    }
    function waveButton(){
      el.buzz.classList.add('wave'); const i = document.createElement('i');
      el.buzz.appendChild(i); setTimeout(()=>{ i.remove(); el.buzz.classList.remove('wave'); }, 600);
    }
    function haptic(ms=35){ try{ navigator.vibrate && navigator.vibrate(ms); }catch{} }
    function tone(freq=740, dur=160, gain=.35){
      try{
        const actx = new (window.AudioContext || window.webkitAudioContext)();
        const o = actx.createOscillator(), g = actx.createGain();
        o.connect(g); g.connect(actx.destination);
        o.frequency.value = freq; g.gain.value = gain;
        o.start(); o.stop(actx.currentTime + dur/1000);
      }catch{}
    }

    // ======== LocalStorage ========
    function loadPrefs(){
      const n = localStorage.getItem(LS_NAME_KEY) || '';
      if (n){ el.name.value = n; }
      const t = localStorage.getItem(LS_TEAM_KEY);
      if (t === 'team1') el.t1r.checked = true;
      if (t === 'team2') el.t2r.checked = true;
    }
    function savePrefs(){
      const n = (el.name.value || '').trim();
      if (n) localStorage.setItem(LS_NAME_KEY, n);
      const t = document.querySelector('input[name="team"]:checked')?.value;
      if (t) localStorage.setItem(LS_TEAM_KEY, t);
    }

    // ======== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¹Ø¨Ø± HTTP (Fallback/Ø¨Ø¯Ø¡) ========
    async function loadCurrentOnce(){
      try{
        const r = await fetch(`/games/api/images-get-current/?session_id=${encodeURIComponent(sessionId)}`);
        if (!r.ok) return;
        const data = await r.json();
        const cur = data.current || {};
        setImage(cur.image_url || '');
        setScores(data.team1_score || 0, data.team2_score || 0);
      }catch{}
    }
    function setImage(url){
      if (!url) return;
      el.img.src = url;
      el.img.alt = 'Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØºØ²';
    }
    function setScores(a,b){
      if (el.s1) el.s1.textContent = a;
      if (el.s2) el.s2.textContent = b;
    }

    // ======== WS: Ù‚Ù†Ø§Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ ========
    function connectContestantWS(){
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const url = `${proto}://${location.host}/ws/pictures/${encodeURIComponent(sessionId)}/?role=contestant`;
      try{ wsContest = new WebSocket(url); }catch{ setConn(); return; }

      wsContest.onopen = ()=>{
        d1 = 1000; setConn();
        clearInterval(hb1);
        hb1 = setInterval(()=>{ try{ wsContest.readyState===1 && wsContest.send(JSON.stringify({type:'ping'})); }catch{} }, 20000);
      };
      wsContest.onmessage = (ev)=>{
        let d={}; try{ d = JSON.parse(ev.data||'{}'); }catch{ return; }
        if (d.type === 'buzz_confirmed'){
          showMsg('ok', d.message || 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¶ØºØ·ØªÙƒ!', 2500);
          tone(840, 220, .4); haptic(30);
          setTimeout(enableBuzz, 900);
        } else if (d.type === 'buzz_rejected'){
          showMsg('err', d.message || 'âš ï¸ Ø§Ù„Ø²Ø± Ù…Ø­Ø¬ÙˆØ² Ø§Ù„Ø¢Ù†', 3000);
          tone(360, 180, .25); haptic(40);
          setTimeout(enableBuzz, 400);
        } else if (d.type === 'error'){
          showMsg('err', d.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£.', 3200);
          setTimeout(enableBuzz, 600);
        }
      };
      wsContest.onclose = (e)=>{
        clearInterval(hb1); setConn();
        if (e && (e.code===4401 || e.code===4404)){ showMsg('err','Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© Ø£Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­.'); disableBuzz(true); return; }
        setTimeout(connectContestantWS, d1); d1 = Math.min(d1*2, MAX_DELAY);
      };
      wsContest.onerror = ()=>{ try{ wsContest.close(); }catch{} };
    }

    // ======== WS: Ù‚Ù†Ø§Ø© Ø§Ù„Ø¹Ø±Ø¶/Ø§Ù„ØªØºØ°ÙŠØ© (Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù†Ù‚Ø§Ø·) ========
    function connectFeedWS(){
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const url = `${proto}://${location.host}/ws/pictures/${encodeURIComponent(sessionId)}/?role=display`;
      try{ wsFeed = new WebSocket(url); }catch{ setConn(); return; }

      wsFeed.onopen = ()=>{
        d2 = 1000; setConn();
        clearInterval(hb2);
        hb2 = setInterval(()=>{ try{ wsFeed.readyState===1 && wsFeed.send(JSON.stringify({type:'ping'})); }catch{} }, 20000);
      };
      wsFeed.onmessage = (ev)=>{
        let d={}; try{ d = JSON.parse(ev.data||'{}'); }catch{ return; }
        if (d.type === 'puzzle_updated'){
          setImage(d.image_url || '');
        } else if (d.type === 'scores_updated'){
          setScores(d.team1_score||0, d.team2_score||0);
        }
        // Ù†ØªØ¬Ø§Ù‡Ù„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø§Ø²Ø±/Ø§Ù„Ø¹Ø¯Ù‘ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù‡Ù†Ø§
      };
      wsFeed.onclose = ()=>{
        clearInterval(hb2); setConn();
        setTimeout(connectFeedWS, d2); d2 = Math.min(d2*2, MAX_DELAY);
      };
      wsFeed.onerror = ()=>{ try{ wsFeed.close(); }catch{} };
    }

    // ======== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù†Ø·ÙŠØ· ========
    let busy = false;
    function disableBuzz(permanent=false){
      busy = true; el.buzz.disabled = true; el.buzzText.textContent = permanent ? 'ØºÙŠØ± Ù…ØªØ§Ø­' : 'Ø¬Ø§Ø±Ù...';
    }
    function enableBuzz(){ busy = false; el.buzz.disabled = false; el.buzzText.textContent = 'Ø¬Ø§ÙˆÙØ¨!' }
    function sendBuzz(){
      const name = (el.name.value || '').trim();
      const team = document.querySelector('input[name="team"]:checked')?.value;

      if (!name){ showMsg('err','Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹', 2200); el.name.focus(); haptic(30); return; }
      if (!team){ showMsg('err','Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ', 2200); haptic(30); return; }
      if (!wsContest || wsContest.readyState !== 1){ showMsg('err','Ø§Ù„Ø§ØªØµØ§Ù„ ØºÙŠØ± Ø¬Ø§Ù‡Ø²', 2200); haptic(30); return; }
      if (busy) return;

      waveButton(); haptic(50); tone(760, 130, .35);
      disableBuzz();
      savePrefs();

      try{
        wsContest.send(JSON.stringify({
          type:'contestant_buzz',
          contestant_name:name,
          team,
          timestamp:new Date().toISOString()
        }));
        // fallback ÙØªØ­ Ø§Ù„Ø²Ø± Ù„Ùˆ Ù…Ø§ ÙˆØµÙ„ Ø±Ø¯ Ø³Ø±ÙŠØ¹
        setTimeout(()=>{ if (busy) enableBuzz(); }, 1200);
        showMsg('info','â³ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...', 1200);
      }catch{
        showMsg('err','ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§', 2500);
        enableBuzz();
      }
    }

    // ======== ØªÙ‡ÙŠØ¦Ø© ========
    document.addEventListener('DOMContentLoaded', ()=>{
      loadPrefs();
      loadCurrentOnce();     // Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ Ù‚Ø¨Ù„ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ WS
      connectContestantWS(); // Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
      connectFeedWS();       // Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„Ù†Ù‚Ø§Ø·

      el.buzz.addEventListener('click', sendBuzz);
      el.name.addEventListener('keypress', (e)=>{ if (e.key === 'Enter') sendBuzz(); });

      // ØªØ­Ø³ÙŠÙ†Ø§Øª ØµÙˆØª Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (ÙØªØ­ AudioContext)
      document.addEventListener('touchstart', ()=>tone(1,1,.0001), { once:true, passive:true });

      // Ø­Ø§Ù„Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†/Ø£ÙˆÙÙ„Ø§ÙŠÙ†
      window.addEventListener('online',  setConn);
      window.addEventListener('offline', setConn);
    });

    window.buzzAnswer = sendBuzz; // Ù„Ùˆ Ø§Ø­ØªØ¬Øª ØªÙ†Ø§Ø¯ÙŠÙ‡Ø§ Ù…Ù† HTML
  </script>
</body>
</html>
