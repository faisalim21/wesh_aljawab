<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  {# ==== META + SOCIAL (مماثل لباقي الصفحات) ==== #}
  <title>{% block title %}{{ page_title|default:"وش الجواب - المضيف (تحدّي الصور)" }}{% endblock %}</title>
  <meta name="description" content="{% block meta_description %}{{ page_description|default:'صفحة المضيف لتحدّي الصور من منصة وش الجواب.' }}{% endblock %}">
  <meta name="robots" content="noindex,follow">
  <link rel="canonical" href="{% if request %}{{ request.build_absolute_uri }}{% else %}https://wesh-aljawab.onrender.com/{% endif %}">
  <meta property="og:locale" content="ar_SA">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="وش الجواب">
  <meta property="og:title" content="{% block og_title %}{{ page_title|default:'وش الجواب - المضيف (تحدّي الصور)' }}{% endblock %}">
  <meta property="og:description" content="{% block og_description %}{{ page_description|default:'صفحة المضيف لتحدّي الصور من منصة وش الجواب.' }}{% endblock %}">
  <meta property="og:url" content="{% if request %}{{ request.build_absolute_uri }}{% else %}https://wesh-aljawab.onrender.com/{% endif %}">
  <meta property="og:image" content="{% firstof page_og_image 'https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png' %}">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#4f46e5">
  <meta name="theme-color" media="(prefers-color-scheme: dark)"  content="#4f46e5">

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg1:#1e3a8a; --bg2:#3730a3; --bg3:#581c87;
      --glass:rgba(255,255,255,.18);
      --br:18px;
      --fg:#fff;
      --card-border:rgba(255,255,255,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:0; overflow:hidden;
      min-height:100vh; color:var(--fg);
      background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
      font-family:'Tajawal',sans-serif;
    }

    /* شعار أعلى اليمين */
    .logo{position:fixed;top:16px;right:16px;z-index:12;background:#fff;border-radius:16px;padding:10px 14px;border:1px solid rgba(0,0,0,.06);box-shadow:0 12px 30px rgba(0,0,0,.25)}
    .logo img{height:80px;display:block}

    /* البطاقات: الروابط للشاشتين + الأزرار + النقاط */
    .topbar{
      position:fixed; top:16px; left:16px; z-index:12;
      display:flex; flex-direction:column; gap:10px;
    }
    .card{
      background:var(--glass); backdrop-filter:blur(14px);
      border:3px solid var(--card-border); border-radius:16px;
      padding:12px 14px; box-shadow:0 10px 26px rgba(0,0,0,.28);
    }
    .links{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .links a{
      color:#fff; text-decoration:none; font-weight:900; font-size:.95rem;
      border:2px solid rgba(255,255,255,.55);
      padding:6px 10px; border-radius:12px;
    }

    .scores{display:flex; gap:10px}
    .scard{min-width:150px; text-align:center}
    .nm{font-size:1rem;font-weight:900;margin-bottom:4px;letter-spacing:.3px}
    .sc{font-size:2rem;font-weight:900;line-height:1}

    /* الحاوية الرئيسية */
    .wrap{position:fixed; inset:0; display:grid; grid-template-rows:auto 1fr auto; gap:14px; padding:120px 20px 20px}
    .stage{
      display:grid; grid-template-columns:1.2fr .8fr; gap:14px; height:100%;
    }
    .frame{
      background:#000; border-radius:var(--br); overflow:hidden;
      display:grid; place-items:center; box-shadow:0 22px 60px rgba(0,0,0,.35)
    }
    .frame img{max-width:100%;max-height:100%;display:block}

    .info{
      display:grid; grid-template-rows:auto 1fr 1fr; gap:12px; min-height:0;
    }
    .ibox{
      background:var(--glass); backdrop-filter:blur(14px);
      border:3px solid var(--card-border); border-radius:16px;
      padding:12px 14px; box-shadow:0 10px 26px rgba(0,0,0,.28);
      display:flex; flex-direction:column;
      min-height:0;
    }
    .ibox h3{margin:0 0 8px 0; font-size:1.05rem; font-weight:900}
    .ibox .content{
      font-size:1.05rem; font-weight:700; line-height:1.6;
      overflow:auto;
    }
    .muted{opacity:.8}

    /* أزرار التنقل أسفل */
    .controls{
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn{
      background:var(--glass); color:#fff; border:2px solid var(--card-border);
      font-weight:900; font-size:1rem; padding:10px 16px; border-radius:12px;
      cursor:pointer; user-select:none;
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .index{display:flex; align-items:center; gap:6px}
    .index input{
      width:72px; padding:6px 8px; border-radius:10px; border:2px solid var(--card-border);
      background:rgba(255,255,255,.12); color:#fff; font-weight:900; text-align:center;
    }
    .hinting{opacity:.7}

    @media (max-width:1100px){
      .stage{grid-template-columns:1fr; grid-auto-rows:auto 1fr}
      .wrap{padding-top:110px}
    }
    @media (max-width:768px){
      .logo, .links{display:none}
      .wrap{padding:90px 12px 12px}
    }
  </style>
</head>
<body>

  <!-- الشعار -->
  <div class="logo">
    <img src="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png" alt="وش الجواب">
  </div>

  <!-- الروابط + النقاط -->
  <div class="topbar">
    <div class="card links">
      <a href="{{ display_url }}" target="_blank" rel="noopener">👀 فتح شاشة العرض</a>
      <a href="{{ contestants_url }}" target="_blank" rel="noopener">🙋 صفحة المتسابقين</a>
    </div>

    <div class="card scores">
      <div class="card scard">
        <div class="nm">{{ session.team1_name }}</div>
        <div class="sc" id="t1">0</div>
      </div>
      <div class="card scard">
        <div class="nm">{{ session.team2_name }}</div>
        <div class="sc" id="t2">0</div>
      </div>
    </div>
  </div>

  <!-- المحتوى الرئيسي -->
  <div class="wrap">
    <div class="stage">
      <!-- الصورة -->
      <div class="frame">
        <img id="pic" alt="الصورة الحالية" />
      </div>

      <!-- التلميح/الإجابة -->
      <div class="info">
        <div class="ibox">
          <h3>التلميح</h3>
          <div id="hint" class="content muted">جار التحميل…</div>
        </div>
        <div class="ibox">
          <h3>الإجابة</h3>
          <div id="answer" class="content muted">جار التحميل…</div>
        </div>
        <div class="ibox">
          <h3>ملاحظات المضيف</h3>
          <div class="content">
            • يمكن فتح شاشة العرض والمتسابقين من الأعلى.<br>
            • أثناء الانتقال للصورة التالية قد تظهر عبارة “جار التحميل…” جزء من الثانية — هذا طبيعي عند جلب التلميح/الإجابة.
          </div>
        </div>
      </div>
    </div>

    <!-- عناصر التحكم -->
    <div class="controls">
      <!-- انعكاس الأسهم: السهم الأيمن = السابق (تماشيًا مع اتجاه RTL) -->
      <button class="btn" id="prevBtn">◀ السابق</button>
      <button class="btn" id="nextBtn">التالي ▶</button>
      <div class="index">
        <span class="btn hinting" style="pointer-events:none">اذهب إلى:</span>
        <input id="idx" type="number" min="1" value="{{ current_index|default:1 }}">
        <button class="btn" id="goBtn">انتقال</button>
      </div>
      <span class="btn hinting" style="pointer-events:none">عدد الألغاز: <b id="countLbl">{{ riddles_count|default:0 }}</b></span>
    </div>
  </div>

<script>
  // ====== إعدادات أساسية ======
  const SESSION_ID = '{{ session.id }}';
  const TEAM1 = '{{ session.team1_name|escapejs }}';
  const TEAM2 = '{{ session.team2_name|escapejs }}';
  const WS_URL = `${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws/pictures/${SESSION_ID}/?role=host`;

  // عناصر DOM
  const $img   = document.getElementById('pic');
  const $hint  = document.getElementById('hint');
  const $ans   = document.getElementById('answer');
  const $t1    = document.getElementById('t1');
  const $t2    = document.getElementById('t2');
  const $prev  = document.getElementById('prevBtn');
  const $next  = document.getElementById('nextBtn');
  const $go    = document.getElementById('goBtn');
  const $idx   = document.getElementById('idx');
  const $count = document.getElementById('countLbl');

  // حالة محلية + تحميل مسبق
  let preloader = new Image();
  let currentIndex = Number('{{ current_index|default:1 }}') || 1;
  let totalCount  = Number('{{ riddles_count|default:0 }}') || 0;

  // ====== أدوات مساعدة ======
  function setPic(url){
    $img.src = url || '';
    $img.alt = 'الصورة الحالية';
  }
  function setHint(text, isLoading=false){
    $hint.textContent = (text && !isLoading) ? text : 'جار التحميل…';
    $hint.classList.toggle('muted', isLoading || !text);
  }
  function setAnswer(text, isLoading=false){
    $ans.textContent = (text && !isLoading) ? text : 'جار التحميل…';
    $ans.classList.toggle('muted', isLoading || !text);
  }
  function setScores(a,b){ $t1.textContent = a||0; $t2.textContent = b||0; }
  function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

  async function fetchCurrent(){
    try{
      const r = await fetch(`/games/api/images-get-current/?session_id=${encodeURIComponent(SESSION_ID)}`);
      if(r.status===410){ alert('انتهت صلاحية الجلسة'); return; }
      if(!r.ok) return;
      const d = await r.json();
      totalCount = Number(d.count||0);
      currentIndex = Number(d.current_index||1);
      $count.textContent = totalCount;
      $idx.value = currentIndex;

      const cur = d.current || {};
      setPic(cur.image_url || '');
      setHint(cur.hint || '', !cur.hint);
      setAnswer(cur.answer || '', !cur.answer);

      // تحميل مسبق للصورة التالية/السابقة
      if(d.next_image_url){ preloader.src = d.next_image_url; }
      if(d.prev_image_url){ (new Image()).src = d.prev_image_url; }
    }catch(e){}
  }

  // ====== عمليات السيرفر (تحكم) ======
  async function postJSON(url, body){
    const r = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body||{})
    });
    return r.ok ? r.json() : null;
  }

  async function goPrev(){
    // تفاؤليًا: اعرض تحميل للتلميح/الإجابة فور الضغط
    setHint('', true); setAnswer('', true);
    const d = await postJSON('/games/api/images-prev/', {session_id: SESSION_ID});
    if(!d) return;
    totalCount = Number(d.count||0);
    currentIndex = Number(d.current_index||1);
    $idx.value = currentIndex; $count.textContent = totalCount;

    const cur = d.current || {};
    setPic(cur.image_url || '');
    setHint(cur.hint || '', !cur.hint);
    setAnswer(cur.answer || '', !cur.answer);

    // تحميل مسبق
    if(d.prev_image_url){ preloader.src = d.prev_image_url; }
  }

  async function goNext(){
    setHint('', true); setAnswer('', true);
    const d = await postJSON('/games/api/images-next/', {session_id: SESSION_ID});
    if(!d) return;
    totalCount = Number(d.count||0);
    currentIndex = Number(d.current_index||1);
    $idx.value = currentIndex; $count.textContent = totalCount;

    const cur = d.current || {};
    setPic(cur.image_url || '');
    setHint(cur.hint || '', !cur.hint);
    setAnswer(cur.answer || '', !cur.answer);

    if(d.next_image_url){ preloader.src = d.next_image_url; }
  }

  async function goIndex(n){
    n = clamp(Number(n)||1, 1, totalCount||1);
    setHint('', true); setAnswer('', true);
    const d = await postJSON('/games/api/images-set-index/', {session_id: SESSION_ID, index: n});
    if(!d) return;
    totalCount = Number(d.count||0);
    currentIndex = Number(d.current_index||1);
    $idx.value = currentIndex; $count.textContent = totalCount;

    const cur = d.current || {};
    setPic(cur.image_url || '');
    setHint(cur.hint || '', !cur.hint);
    setAnswer(cur.answer || '', !cur.answer);

    // تحميل مسبق للصورة التالية/السابقة (إن وُجدت في الاستجابة)
    if(d.next_image_url){ preloader.src = d.next_image_url; }
    if(d.prev_image_url){ (new Image()).src = d.prev_image_url; }
  }

  // ====== WebSocket ======
  let ws=null, hb=null, delay=1000, maxDelay=5000;
  function connectWS(){
    ws = new WebSocket(WS_URL);

    ws.onopen = ()=>{
      delay=1000;
      hb && clearInterval(hb);
      hb = setInterval(()=>{ try{ ws.readyState===1 && ws.send(JSON.stringify({type:'ping'})); }catch{} }, 20000);
    };

    ws.onmessage = (ev)=>{
      let d={}; try{ d = JSON.parse(ev.data||'{}'); }catch{ return; }
      switch(d.type){
        case 'puzzle_updated':
          // نحدّث الصورة فورًا
          if(d.image_url){ setPic(d.image_url); }
          // لو ما وصل hint/answer نعرض "جار التحميل…" ثم نجلبها عبر API
          if(typeof d.hint === 'undefined'){ setHint('', true); } else { setHint(d.hint||'', !d.hint); }
          if(typeof d.answer === 'undefined'){ setAnswer('', true); } else { setAnswer(d.answer||'', !d.answer); }

          // إن لم تصل التفاصيل، نسحبها سريعًا من الـAPI
          if(typeof d.hint === 'undefined' || typeof d.answer === 'undefined'){
            // نداء غير حاجب لملء التفاصيل
            fetchCurrent();
          }

          // تحديث الفهرس والعدد إن وُجد
          if(d.current_index){ currentIndex = Number(d.current_index)||currentIndex; $idx.value = currentIndex; }
          if(d.count){ totalCount = Number(d.count)||totalCount; $count.textContent = totalCount; }
          break;

        case 'scores_updated':
          setScores(d.team1_score, d.team2_score);
          break;

        case 'pong': break;
        default: break;
      }
    };

    ws.onclose = ()=>{
      hb && clearInterval(hb);
      setTimeout(connectWS, delay);
      delay = Math.min(delay*2, maxDelay);
    };
    ws.onerror = ()=>{ try{ ws.close(); }catch{} };
  }

  // ====== ربط العناصر ======
  document.addEventListener('DOMContentLoaded', ()=>{
    // تحميل الحالة الأولية
    fetchCurrent();
    connectWS();

    // إنعكاس الأسهم: الأيمن = السابق، الأيسر = التالي
    $prev.addEventListener('click', goPrev);
    $next.addEventListener('click', goNext);
    $go.addEventListener('click', ()=> goIndex($idx.value));
    $idx.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ goIndex($idx.value); } });
  });

  window.addEventListener('beforeunload', ()=>{
    try{ hb && clearInterval(hb); ws && ws.close(1000,'page unload'); }catch{}
  });
</script>

</body>
</html>
