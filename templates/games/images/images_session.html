<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  {# ==== META + SOCIAL (Ù…Ù…Ø§Ø«Ù„ Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØµÙØ­Ø§Øª) ==== #}
  <title>{% block title %}{{ page_title|default:"ÙˆØ´ Ø§Ù„Ø¬ÙˆØ§Ø¨ - Ø§Ù„Ù…Ø¶ÙŠÙ (ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„ØµÙˆØ±)" }}{% endblock %}</title>
  <meta name="description" content="{% block meta_description %}{{ page_description|default:'ØµÙØ­Ø© Ø§Ù„Ù…Ø¶ÙŠÙ Ù„ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„ØµÙˆØ± Ù…Ù† Ù…Ù†ØµØ© ÙˆØ´ Ø§Ù„Ø¬ÙˆØ§Ø¨.' }}{% endblock %}">
  <meta name="robots" content="noindex,follow">
  <link rel="canonical" href="{% if request %}{{ request.build_absolute_uri }}{% else %}https://wesh-aljawab.onrender.com/{% endif %}">
  <meta property="og:locale" content="ar_SA">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="ÙˆØ´ Ø§Ù„Ø¬ÙˆØ§Ø¨">
  <meta property="og:title" content="{% block og_title %}{{ page_title|default:'ÙˆØ´ Ø§Ù„Ø¬ÙˆØ§Ø¨ - Ø§Ù„Ù…Ø¶ÙŠÙ (ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„ØµÙˆØ±)' }}{% endblock %}">
  <meta property="og:description" content="{% block og_description %}{{ page_description|default:'ØµÙØ­Ø© Ø§Ù„Ù…Ø¶ÙŠÙ Ù„ØªØ­Ø¯Ù‘ÙŠ Ø§Ù„ØµÙˆØ± Ù…Ù† Ù…Ù†ØµØ© ÙˆØ´ Ø§Ù„Ø¬ÙˆØ§Ø¨.' }}{% endblock %}">
  <meta property="og:url" content="{% if request %}{{ request.build_absolute_uri }}{% else %}https://wesh-aljawab.onrender.com/{% endif %}">
  <meta property="og:image" content="{% firstof page_og_image 'https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png' %}">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#4f46e5">
  <meta name="theme-color" media="(prefers-color-scheme: dark)"  content="#4f46e5">

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg1:#1e3a8a; --bg2:#3730a3; --bg3:#581c87;
      --glass:rgba(255,255,255,.18);
      --br:18px;
      --fg:#fff;
      --card-border:rgba(255,255,255,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:0; overflow:hidden;
      min-height:100vh; color:var(--fg);
      background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
      font-family:'Tajawal',sans-serif;
    }

    /* Ø´Ø¹Ø§Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
    .logo{position:fixed;top:16px;right:16px;z-index:12;background:#fff;border-radius:16px;padding:10px 14px;border:1px solid rgba(0,0,0,.06);box-shadow:0 12px 30px rgba(0,0,0,.25)}
    .logo img{height:80px;display:block}

    /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª: Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù„Ù„Ø´Ø§Ø´ØªÙŠÙ† + Ø§Ù„Ø£Ø²Ø±Ø§Ø± + Ø§Ù„Ù†Ù‚Ø§Ø· */
    .topbar{
      position:fixed; top:16px; left:16px; z-index:12;
      display:flex; flex-direction:column; gap:10px;
    }
    .card{
      background:var(--glass); backdrop-filter:blur(14px);
      border:3px solid var(--card-border); border-radius:16px;
      padding:12px 14px; box-shadow:0 10px 26px rgba(0,0,0,.28);
    }
    .links{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .links a{
      color:#fff; text-decoration:none; font-weight:900; font-size:.95rem;
      border:2px solid rgba(255,255,255,.55);
      padding:6px 10px; border-radius:12px;
    }

    .scores{display:flex; gap:10px}
    .scard{min-width:150px; text-align:center}
    .nm{font-size:1rem;font-weight:900;margin-bottom:4px;letter-spacing:.3px}
    .sc{font-size:2rem;font-weight:900;line-height:1}

    /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
    .wrap{position:fixed; inset:0; display:grid; grid-template-rows:auto 1fr auto; gap:14px; padding:120px 20px 20px}
    .stage{
      display:grid; grid-template-columns:1.2fr .8fr; gap:14px; height:100%;
    }
    .frame{
      background:#000; border-radius:var(--br); overflow:hidden;
      display:grid; place-items:center; box-shadow:0 22px 60px rgba(0,0,0,.35)
    }
    .frame img{max-width:100%;max-height:100%;display:block}

    .info{
      display:grid; grid-template-rows:auto 1fr 1fr; gap:12px; min-height:0;
    }
    .ibox{
      background:var(--glass); backdrop-filter:blur(14px);
      border:3px solid var(--card-border); border-radius:16px;
      padding:12px 14px; box-shadow:0 10px 26px rgba(0,0,0,.28);
      display:flex; flex-direction:column;
      min-height:0;
    }
    .ibox h3{margin:0 0 8px 0; font-size:1.05rem; font-weight:900}
    .ibox .content{
      font-size:1.05rem; font-weight:700; line-height:1.6;
      overflow:auto;
    }
    .muted{opacity:.8}

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø£Ø³ÙÙ„ */
    .controls{
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn{
      background:var(--glass); color:#fff; border:2px solid var(--card-border);
      font-weight:900; font-size:1rem; padding:10px 16px; border-radius:12px;
      cursor:pointer; user-select:none;
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .index{display:flex; align-items:center; gap:6px}
    .index input{
      width:72px; padding:6px 8px; border-radius:10px; border:2px solid var(--card-border);
      background:rgba(255,255,255,.12); color:#fff; font-weight:900; text-align:center;
    }
    .hinting{opacity:.7}

    @media (max-width:1100px){
      .stage{grid-template-columns:1fr; grid-auto-rows:auto 1fr}
      .wrap{padding-top:110px}
    }
    @media (max-width:768px){
      .logo, .links{display:none}
      .wrap{padding:90px 12px 12px}
    }
  </style>
</head>
<body>

  <!-- Ø§Ù„Ø´Ø¹Ø§Ø± -->
  <div class="logo">
    <img src="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png" alt="ÙˆØ´ Ø§Ù„Ø¬ÙˆØ§Ø¨">
  </div>

  <!-- Ø§Ù„Ø±ÙˆØ§Ø¨Ø· + Ø§Ù„Ù†Ù‚Ø§Ø· -->
  <div class="topbar">
    <div class="card links">
      <a href="{{ display_url }}" target="_blank" rel="noopener">ğŸ‘€ ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶</a>
      <a href="{{ contestants_url }}" target="_blank" rel="noopener">ğŸ™‹ ØµÙØ­Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</a>
    </div>

    <div class="card scores">
      <div class="card scard">
        <div class="nm">{{ session.team1_name }}</div>
        <div class="sc" id="t1">0</div>
      </div>
      <div class="card scard">
        <div class="nm">{{ session.team2_name }}</div>
        <div class="sc" id="t2">0</div>
      </div>
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <div class="wrap">
    <div class="stage">
      <!-- Ø§Ù„ØµÙˆØ±Ø© -->
      <div class="frame">
        <img id="pic" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©" />
      </div>

      <!-- Ø§Ù„ØªÙ„Ù…ÙŠØ­/Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© -->
      <div class="info">
        <div class="ibox">
          <h3>Ø§Ù„ØªÙ„Ù…ÙŠØ­</h3>
          <div id="hint" class="content muted">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>
        </div>
        <div class="ibox">
          <h3>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</h3>
          <div id="answer" class="content muted">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>
        </div>
        <div class="ibox">
          <h3>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø¶ÙŠÙ</h3>
          <div class="content">
            â€¢ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰.<br>
            â€¢ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù‚Ø¯ ØªØ¸Ù‡Ø± Ø¹Ø¨Ø§Ø±Ø© â€œØ¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦â€ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø«Ø§Ù†ÙŠØ© â€” Ù‡Ø°Ø§ Ø·Ø¨ÙŠØ¹ÙŠ Ø¹Ù†Ø¯ Ø¬Ù„Ø¨ Ø§Ù„ØªÙ„Ù…ÙŠØ­/Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.
          </div>
        </div>
      </div>
    </div>

    <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="controls">
      <!-- Ø§Ù†Ø¹ÙƒØ§Ø³ Ø§Ù„Ø£Ø³Ù‡Ù…: Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø£ÙŠÙ…Ù† = Ø§Ù„Ø³Ø§Ø¨Ù‚ (ØªÙ…Ø§Ø´ÙŠÙ‹Ø§ Ù…Ø¹ Ø§ØªØ¬Ø§Ù‡ RTL) -->
      <button class="btn" id="prevBtn">â—€ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <button class="btn" id="nextBtn">Ø§Ù„ØªØ§Ù„ÙŠ â–¶</button>
      <div class="index">
        <span class="btn hinting" style="pointer-events:none">Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰:</span>
        <input id="idx" type="number" min="1" value="{{ current_index|default:1 }}">
        <button class="btn" id="goBtn">Ø§Ù†ØªÙ‚Ø§Ù„</button>
      </div>
      <span class="btn hinting" style="pointer-events:none">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„ØºØ§Ø²: <b id="countLbl">{{ riddles_count|default:0 }}</b></span>
    </div>
  </div>

<script>
  // ====== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© ======
  const SESSION_ID = '{{ session.id }}';
  const TEAM1 = '{{ session.team1_name|escapejs }}';
  const TEAM2 = '{{ session.team2_name|escapejs }}';
  const WS_URL = `${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws/pictures/${SESSION_ID}/?role=host`;

  // Ø¹Ù†Ø§ØµØ± DOM
  const $img   = document.getElementById('pic');
  const $hint  = document.getElementById('hint');
  const $ans   = document.getElementById('answer');
  const $t1    = document.getElementById('t1');
  const $t2    = document.getElementById('t2');
  const $prev  = document.getElementById('prevBtn');
  const $next  = document.getElementById('nextBtn');
  const $go    = document.getElementById('goBtn');
  const $idx   = document.getElementById('idx');
  const $count = document.getElementById('countLbl');

  // Ø­Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ© + ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø¨Ù‚
  let preloader = new Image();
  let currentIndex = Number('{{ current_index|default:1 }}') || 1;
  let totalCount  = Number('{{ riddles_count|default:0 }}') || 0;

  // ====== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ======
  function setPic(url){
    $img.src = url || '';
    $img.alt = 'Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©';
  }
  function setHint(text, isLoading=false){
    $hint.textContent = (text && !isLoading) ? text : 'Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦';
    $hint.classList.toggle('muted', isLoading || !text);
  }
  function setAnswer(text, isLoading=false){
    $ans.textContent = (text && !isLoading) ? text : 'Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦';
    $ans.classList.toggle('muted', isLoading || !text);
  }
  function setScores(a,b){ $t1.textContent = a||0; $t2.textContent = b||0; }
  function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

  async function fetchCurrent(){
    try{
      const r = await fetch(`/games/api/images-get-current/?session_id=${encodeURIComponent(SESSION_ID)}`);
      if(r.status===410){ alert('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©'); return; }
      if(!r.ok) return;
      const d = await r.json();
      totalCount = Number(d.count||0);
      currentIndex = Number(d.current_index||1);
      $count.textContent = totalCount;
      $idx.value = currentIndex;

      const cur = d.current || {};
      setPic(cur.image_url || '');
      setHint(cur.hint || '', !cur.hint);
      setAnswer(cur.answer || '', !cur.answer);

      // ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©/Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
      if(d.next_image_url){ preloader.src = d.next_image_url; }
      if(d.prev_image_url){ (new Image()).src = d.prev_image_url; }
    }catch(e){}
  }

  // ====== Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³ÙŠØ±ÙØ± (ØªØ­ÙƒÙ…) ======
  async function postJSON(url, body){
    const r = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body||{})
    });
    return r.ok ? r.json() : null;
  }

  async function goPrev(){
    // ØªÙØ§Ø¤Ù„ÙŠÙ‹Ø§: Ø§Ø¹Ø±Ø¶ ØªØ­Ù…ÙŠÙ„ Ù„Ù„ØªÙ„Ù…ÙŠØ­/Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙÙˆØ± Ø§Ù„Ø¶ØºØ·
    setHint('', true); setAnswer('', true);
    const d = await postJSON('/games/api/images-prev/', {session_id: SESSION_ID});
    if(!d) return;
    totalCount = Number(d.count||0);
    currentIndex = Number(d.current_index||1);
    $idx.value = currentIndex; $count.textContent = totalCount;

    const cur = d.current || {};
    setPic(cur.image_url || '');
    setHint(cur.hint || '', !cur.hint);
    setAnswer(cur.answer || '', !cur.answer);

    // ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø¨Ù‚
    if(d.prev_image_url){ preloader.src = d.prev_image_url; }
  }

  async function goNext(){
    setHint('', true); setAnswer('', true);
    const d = await postJSON('/games/api/images-next/', {session_id: SESSION_ID});
    if(!d) return;
    totalCount = Number(d.count||0);
    currentIndex = Number(d.current_index||1);
    $idx.value = currentIndex; $count.textContent = totalCount;

    const cur = d.current || {};
    setPic(cur.image_url || '');
    setHint(cur.hint || '', !cur.hint);
    setAnswer(cur.answer || '', !cur.answer);

    if(d.next_image_url){ preloader.src = d.next_image_url; }
  }

  async function goIndex(n){
    n = clamp(Number(n)||1, 1, totalCount||1);
    setHint('', true); setAnswer('', true);
    const d = await postJSON('/games/api/images-set-index/', {session_id: SESSION_ID, index: n});
    if(!d) return;
    totalCount = Number(d.count||0);
    currentIndex = Number(d.current_index||1);
    $idx.value = currentIndex; $count.textContent = totalCount;

    const cur = d.current || {};
    setPic(cur.image_url || '');
    setHint(cur.hint || '', !cur.hint);
    setAnswer(cur.answer || '', !cur.answer);

    // ØªØ­Ù…ÙŠÙ„ Ù…Ø³Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©/Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø¥Ù† ÙˆÙØ¬Ø¯Øª ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©)
    if(d.next_image_url){ preloader.src = d.next_image_url; }
    if(d.prev_image_url){ (new Image()).src = d.prev_image_url; }
  }

  // ====== WebSocket ======
  let ws=null, hb=null, delay=1000, maxDelay=5000;
  function connectWS(){
    ws = new WebSocket(WS_URL);

    ws.onopen = ()=>{
      delay=1000;
      hb && clearInterval(hb);
      hb = setInterval(()=>{ try{ ws.readyState===1 && ws.send(JSON.stringify({type:'ping'})); }catch{} }, 20000);
    };

    ws.onmessage = (ev)=>{
      let d={}; try{ d = JSON.parse(ev.data||'{}'); }catch{ return; }
      switch(d.type){
        case 'puzzle_updated':
          // Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙˆØ±Ø© ÙÙˆØ±Ù‹Ø§
          if(d.image_url){ setPic(d.image_url); }
          // Ù„Ùˆ Ù…Ø§ ÙˆØµÙ„ hint/answer Ù†Ø¹Ø±Ø¶ "Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦" Ø«Ù… Ù†Ø¬Ù„Ø¨Ù‡Ø§ Ø¹Ø¨Ø± API
          if(typeof d.hint === 'undefined'){ setHint('', true); } else { setHint(d.hint||'', !d.hint); }
          if(typeof d.answer === 'undefined'){ setAnswer('', true); } else { setAnswer(d.answer||'', !d.answer); }

          // Ø¥Ù† Ù„Ù… ØªØµÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ØŒ Ù†Ø³Ø­Ø¨Ù‡Ø§ Ø³Ø±ÙŠØ¹Ù‹Ø§ Ù…Ù† Ø§Ù„Ù€API
          if(typeof d.hint === 'undefined' || typeof d.answer === 'undefined'){
            // Ù†Ø¯Ø§Ø¡ ØºÙŠØ± Ø­Ø§Ø¬Ø¨ Ù„Ù…Ù„Ø¡ Ø§Ù„ØªÙØ§ØµÙŠÙ„
            fetchCurrent();
          }

          // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‡Ø±Ø³ ÙˆØ§Ù„Ø¹Ø¯Ø¯ Ø¥Ù† ÙˆÙØ¬Ø¯
          if(d.current_index){ currentIndex = Number(d.current_index)||currentIndex; $idx.value = currentIndex; }
          if(d.count){ totalCount = Number(d.count)||totalCount; $count.textContent = totalCount; }
          break;

        case 'scores_updated':
          setScores(d.team1_score, d.team2_score);
          break;

        case 'pong': break;
        default: break;
      }
    };

    ws.onclose = ()=>{
      hb && clearInterval(hb);
      setTimeout(connectWS, delay);
      delay = Math.min(delay*2, maxDelay);
    };
    ws.onerror = ()=>{ try{ ws.close(); }catch{} };
  }

  // ====== Ø±Ø¨Ø· Ø§Ù„Ø¹Ù†Ø§ØµØ± ======
  document.addEventListener('DOMContentLoaded', ()=>{
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    fetchCurrent();
    connectWS();

    // Ø¥Ù†Ø¹ÙƒØ§Ø³ Ø§Ù„Ø£Ø³Ù‡Ù…: Ø§Ù„Ø£ÙŠÙ…Ù† = Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ Ø§Ù„Ø£ÙŠØ³Ø± = Ø§Ù„ØªØ§Ù„ÙŠ
    $prev.addEventListener('click', goPrev);
    $next.addEventListener('click', goNext);
    $go.addEventListener('click', ()=> goIndex($idx.value));
    $idx.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ goIndex($idx.value); } });
  });

  window.addEventListener('beforeunload', ()=>{
    try{ hb && clearInterval(hb); ws && ws.close(1000,'page unload'); }catch{}
  });
</script>

</body>
</html>
