<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🎤 تحدّي الصور — صفحة المتسابق</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet" />
  <style>
    body{margin:0;min-height:100vh;display:grid;place-items:center;background:linear-gradient(135deg,#c084fc,#7c3aed,#5b21b6);font-family:'Tajawal',sans-serif;color:#fff}
    .card{background:rgba(255,255,255,.12);backdrop-filter:blur(16px);padding:24px;border-radius:20px;box-shadow:0 18px 50px rgba(0,0,0,.3);width:min(520px,94vw);text-align:center}
    input, .team{border-radius:12px;border:2px solid rgba(255,255,255,.35);background:rgba(255,255,255,.95);color:#111;font-weight:800}
    .team{padding:10px}
    .buzz{width:180px;height:180px;border-radius:999px;border:0;background:linear-gradient(165deg,#ef4444,#dc2626,#b91c1c);color:#fff;font-weight:900;font-size:1.6rem;box-shadow:0 20px 40px rgba(239,68,68,.4);transition:.12s}
    .buzz:active{transform:scale(.97)}
    .ok{background:rgba(34,197,94,.2);border:2px solid #22c55e;color:#22c55e;border-radius:12px;padding:10px;margin-top:12px;display:none}
    .err{background:rgba(239,68,68,.2);border:2px solid #ef4444;color:#ef4444;border-radius:12px;padding:10px;margin-top:12px;display:none}
  </style>
</head>
<body>
  <div class="card">
    <h3 class="mb-2">🎤 تحدّي الصور — المتسابق</h3>
    <div class="mb-2">{{ session.team1_name }} 🟢 — {{ session.team2_name }} 🟠</div>
    <input id="name" class="form-control text-center fw-bold" placeholder="🏷️ اكتب اسمك" maxlength="20" />
    <div class="d-grid gap-2 mt-2">
      <div class="row g-2">
        <div class="col-6"><label class="team w-100 p-2"><input type="radio" name="team" value="team1"> 🟢 {{ session.team1_name }}</label></div>
        <div class="col-6"><label class="team w-100 p-2"><input type="radio" name="team" value="team2"> 🟠 {{ session.team2_name }}</label></div>
      </div>
    </div>
    <div class="mt-3"><button id="buzz" class="buzz">جاوِب!</button></div>
    <div id="ok" class="ok">✅ تم تسجيل إجابتك!</div>
    <div id="err" class="err">⚠️ الزر محجوز الآن</div>
  </div>

<script>
  const sessionId='{{ session.id }}';
  const WS_URL = `${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws/pictures/${sessionId}/?role=contestant`;
  let ws=null, delay=1000, maxDelay=5000, hb=null, busy=false;

  function connect(){
    ws = new WebSocket(WS_URL);
    ws.onopen=()=>{delay=1000; hb&&clearInterval(hb); hb=setInterval(()=>{try{ws.readyState===1&&ws.send(JSON.stringify({type:'ping'}))}catch{}},20000)}
    ws.onmessage=(ev)=>{let d={};try{d=JSON.parse(ev.data||'{}')}catch{}; if(d.type==='buzz_confirmed'){show('ok');busy=false;btn(true)} else if(d.type==='buzz_rejected'){show('err', d.message);busy=false;btn(true)} }
    ws.onclose=()=>{hb&&clearInterval(hb); setTimeout(connect,delay); delay=Math.min(delay*2,maxDelay)}
    ws.onerror=()=>{try{ws.close()}catch{}}
  }

  function btn(enable){ document.getElementById('buzz').disabled=!enable; document.getElementById('buzz').textContent = enable?'جاوِب!':'جارٍ...'; }
  function show(id, msg){ const ok=document.getElementById('ok'), er=document.getElementById('err'); ok.style.display='none'; er.style.display='none'; const el=document.getElementById(id); if(msg) el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',2500); }

  function sendBuzz(){
    if(busy) return; busy=true; btn(false);
    const name=(document.getElementById('name').value||'').trim();
    const team=document.querySelector('input[name="team"]:checked')?.value;
    if(!name){show('err','اكتب اسمك أولاً'); busy=false; btn(true); return;}
    if(!team){show('err','اختر فريقك'); busy=false; btn(true); return;}
    ws && ws.readyState===1 && ws.send(JSON.stringify({
      type:'contestant_buzz', contestant_name:name, team, timestamp:new Date().toISOString()
    }));
    setTimeout(()=>{ if(busy){ busy=false; btn(true);} },1200);
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('buzz').addEventListener('click', sendBuzz);
    connect();
  });
</script>
</body>
</html>
