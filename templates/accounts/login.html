<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <!-- أساسيات -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{% block title %}{{ page_title|default:"تسجيل الدخول - وش الجواب" }}{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}{{ page_description|default:'اختبر ذكاءك وتحدى أصدقاءك مع منصة وش الجواب للألعاب الذكية التفاعلية.' }}{% endblock %}">
    <meta name="robots" content="index,follow">

    <!-- Canonical -->
    <link rel="canonical" href="{% if request %}{{ request.build_absolute_uri }}{% else %}https://wesh-aljawab.onrender.com/{% endif %}">

    <!-- Open Graph -->
    <meta property="og:locale" content="ar_SA">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="وش الجواب">
    <meta property="og:title" content="{% block og_title %}{{ page_title|default:'وش الجواب - منصة الألعاب الذكية' }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ page_description|default:'اختبر ذكاءك وتحدى أصدقاءك مع منصة وش الجواب للألعاب الذكية التفاعلية.' }}{% endblock %}">
    <meta property="og:url" content="{% if request %}{{ request.build_absolute_uri }}{% else %}https://wesh-aljawab.onrender.com/{% endif %}">
    <meta property="og:image" content="{% firstof page_og_image 'https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png' %}">
    <meta property="og:image:secure_url" content="{% firstof page_og_image 'https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png' %}">
    <meta property="og:image:alt" content="{% block og_image_alt %}{{ page_og_alt|default:'شعار وش الجواب' }}{% endblock %}">
    <!-- <meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"> -->

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}{{ page_title|default:'وش الجواب - منصة الألعاب الذكية' }}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}{{ page_description|default:'اختبر ذكاءك وتحدى أصدقاءك مع منصة وش الجواب للألعاب الذكية التفاعلية.' }}{% endblock %}">
    <meta name="twitter:image" content="{% firstof page_og_image 'https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png' %}">

    <!-- Favicons / Theme -->
    <meta name="theme-color" content="#4f46e5">
    <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png">
    <link rel="apple-touch-icon" href="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png">
    <link rel="mask-icon" href="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png" color="#4f46e5">
    {% block meta_overrides %}{% endblock %}

    <!-- مكتبات واجهة -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --secondary-gradient: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;

            /* سطح المكتب */
            /* لون ثابت آمن لكل الأجهزة */
            --auth-solid-bg: #1e1b4b;

            /* Glass فقط كتحسين */
            --auth-glass-bg: rgba(255,255,255,0.12);


            /* الجوال: أقل شفافية وأكثر راحة */
            --glass-bg-mobile: rgba(15, 18, 39, 0.88);
            --glass-border-mobile: rgba(255, 255, 255, 0.08);
            --field-bg-mobile: rgba(255, 255, 255, 0.12);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            color-scheme: dark;
        }

        /* خلفية زخرفية لطيفة */
        body::before {
            content: '';
            position: absolute; inset: 0; z-index: -1;
            background:
                radial-gradient(circle at 20% 30%, rgba(79, 70, 229, 0.28) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(124, 58, 237, 0.26) 0%, transparent 50%),
                radial-gradient(circle at 60% 20%, rgba(251, 146, 60, 0.16) 0%, transparent 50%);
            animation: floatingBubbles 20s ease-in-out infinite;
        }
        @keyframes floatingBubbles { 0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-20px) scale(1.05)} }

        .auth-container {
            /* fallback أساسي (ما فيه شفافية) */
            background-color: var(--auth-solid-bg);

            /* تحسين خفيف ثابت */
            background-image: linear-gradient(
                180deg,
                rgba(255,255,255,0.08),
                rgba(255,255,255,0.02)
            );

            border-radius: 24px;
            padding: 44px 40px 32px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15),
                        inset 0 1px 0 rgba(255,255,255,0.08);
        }

        @keyframes slideIn { from{opacity:0;transform:translateY(30px) scale(.95)} to{opacity:1;transform:translateY(0) scale(1)} }

        .auth-header { text-align: center; margin-bottom: 28px; }

        /* شعار أكبر وبروز أعلى */
        .logo-link { display:inline-block; text-decoration:none; }
        .logo-container {
            width: 160px; height: 160px; /* تكبير واضح */
            margin: 0 auto 16px;
            background: rgba(255,255,255,0.18);
            border-radius: 28px;
            display:flex; align-items:center; justify-content:center;
            padding: 18px;
            box-shadow: 0 22px 44px rgba(0,0,0,.24), 0 0 90px rgba(124,58,237,.3), inset 0 2px 16px rgba(255,255,255,.28);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,.28);
            animation: logoFloat 4s ease-in-out infinite;
        }
        .logo-img {
            width: 100%; height: 100%; object-fit: contain; border-radius: 14px;
            filter: drop-shadow(0 6px 12px rgba(0,0,0,.35));
            transition: transform .25s ease, filter .25s ease;
        }
        .logo-link:hover .logo-img { transform: scale(1.02); filter: drop-shadow(0 8px 16px rgba(0,0,0,.4)); }
        @keyframes logoFloat { 0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-8px) scale(1.02)} }

        .auth-title { font-size: 2rem; font-weight: 800; color:#fff; margin-bottom: 4px; text-shadow: 2px 2px 4px rgba(0,0,0,.08); }
        .auth-subtitle { color: rgba(255,255,255,.9); font-size: 1rem; margin-bottom: 8px; }

        .form-group { position: relative; margin-bottom: 20px; }
        .form-label { color:#fff; font-weight:600; margin-bottom:8px; display:block; font-size:.98rem; }

        .form-control {
            background: rgba(255,255,255,.12);
            border: 2px solid rgba(255,255,255,.22);
            border-radius: 14px;
            padding: 14px 20px;
            color:#fff; font-size:1rem; width:100%;
            transition: all .2s ease;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }

        .form-control {
            background-color: #312e81;
            color: #fff;
        }

        .form-control:focus {
            outline:none; border-color: rgba(124,58,237,.95);
            background: rgba(255,255,255,.16);
            box-shadow: 0 0 0 4px rgba(124,58,237,.14);
            transform: translateY(-1px);
        }
        .form-control::placeholder { color: rgba(255,255,255,.7); }

        .input-icon { position:absolute; left:16px; top:50%; transform:translateY(-50%); color:rgba(255,255,255,.75); font-size:1.1rem; }
        .form-control.with-icon { padding-left: 46px; }

        .password-toggle {
            position:absolute; left:46px; top:50%; transform:translateY(-50%);
            cursor:pointer; color:rgba(255,255,255,.75); z-index:10;
        }
        .password-toggle:hover { color:#fff; }

        .remember-me {
            display:flex; align-items:center; gap:10px; margin: 6px 0 18px;
        }
        .remember-me input[type="checkbox"]{
            appearance:none; width:20px; height:20px;
            background: rgba(255,255,255,.12);
            border:2px solid rgba(255,255,255,.3);
            border-radius: 6px; cursor:pointer; position:relative; transition: all .2s ease;
        }
        .remember-me input[type="checkbox"]:checked{
            background: var(--secondary-gradient);
            border-color: rgba(124,58,237,.85);
        }
        .remember-me input[type="checkbox"]:checked::after{
            content:'✓'; position:absolute; top:-2px; left:3px; color:#fff; font-weight:700; font-size:14px;
        }
        .remember-me label{ color:rgba(255,255,255,.9); cursor:pointer; user-select:none; }

        .btn-login {
            background: var(--secondary-gradient);
            border:none; border-radius:14px; padding: 15px 30px;
            color:#fff; font-size:1.1rem; font-weight:800; width:100%;
            transition: transform .15s ease, box-shadow .15s ease;
            box-shadow: 0 12px 26px rgba(139,92,246,.38);
            position:relative; overflow:hidden;
        }
        .btn-login:hover { transform: translateY(-2px); box-shadow:0 16px 34px rgba(139,92,246,.48); }
        .btn-login:disabled { opacity:.78; cursor:not-allowed; }

        .loading { display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }
        .spinner { width:20px; height:20px; border:2px solid rgba(255,255,255,.3); border-top:2px solid #fff; border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }

        .auth-links { text-align:center; margin-top: 18px; padding-top:14px; border-top:1px solid rgba(255,255,255,.12); }
        .auth-link { color:rgba(255,255,255,.9); font-weight:700; text-decoration:none; }
        .auth-link:hover { color:#fff; text-decoration:underline; }

        /* الجوال: تخفيف الزخارف والشفافية وتكبير الشعار */
        @media (max-width: 768px){
            .auth-container{
                padding: 32px 22px 24px;
                max-width: 94vw;
                background: var(--glass-bg-mobile);
                backdrop-filter: none; -webkit-backdrop-filter: none;
                border: 1px solid var(--glass-border-mobile);
                box-shadow: 0 22px 46px rgba(0,0,0,.30);
            }
            body::before{
                background:
                    radial-gradient(circle at 20% 30%, rgba(79,70,229,.18) 0%, transparent 50%),
                    radial-gradient(circle at 80% 70%, rgba(124,58,237,.16) 0%, transparent 50%),
                    radial-gradient(circle at 60% 20%, rgba(251,146,60,.10) 0%, transparent 50%);
                animation: none;
            }
            .logo-container{ width: 140px; height: 140px; padding: 16px; animation: none; } /* شعار أكبر على الجوال */
            .auth-title{ font-size: 1.8rem; }
            .form-control{ background: var(--field-bg-mobile); padding: 13px 16px; }
            .form-control.with-icon{ padding-left: 44px; }
        }

        @media (max-width: 480px){
            .logo-container{ width: 130px; height: 130px; }
            .auth-title{ font-size: 1.6rem; }
        }

        /* احترام تفضيل تقليل الحركة */
        @media (prefers-reduced-motion: reduce){
            *{ animation:none !important; transition:none !important; }

        }


        @supports ((-webkit-backdrop-filter: blur(10px)) or (backdrop-filter: blur(10px))) {
            .auth-container {
                background-color: var(--auth-glass-bg);
                backdrop-filter: blur(18px);
                -webkit-backdrop-filter: blur(18px);
            }
        }
        @supports (-webkit-touch-callout: none) {
            .auth-container {
                background-color: #1f1c5c !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }
        }

    </style>
</head>
<body>
    <div class="auth-container" role="main" aria-labelledby="loginTitle">
        <div class="auth-header">
            <!-- الشعار كبير ومضيء ويمكن الضغط عليه للرجوع للرئيسية -->
            <a href="{% url 'home' %}" class="logo-link" aria-label="العودة للرئيسية">
                <div class="logo-container" aria-hidden="true">
                    <img
                        src="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png"
                        alt="وش الجواب"
                        class="logo-img"
                        width="160" height="160"
                        loading="eager" decoding="async">
                </div>
            </a>
            <h1 class="auth-title" id="loginTitle">أسفرت وأنورت</h1>
        </div>

        <!-- رسائل التنبيه من Django -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {% if message.tags == 'success' %}
                        <i class="fas fa-check-circle me-2" aria-hidden="true"></i>
                    {% else %}
                        <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>
                    {% endif %}
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" action="{% url 'accounts:login' %}" id="loginForm" novalidate>
            {% csrf_token %}

            <!-- البريد الإلكتروني -->
            <div class="form-group">
                <label class="form-label" for="email">
                    <i class="fas fa-envelope me-1" aria-hidden="true"></i> البريد الإلكتروني
                </label>
                <div class="position-relative">
                    <input
                        type="email"
                        class="form-control with-icon"
                        id="email"
                        name="email"
                        placeholder="example@email.com"
                        required
                        inputmode="email"
                        autocomplete="email username"
                        autofocus
                        aria-required="true"
                        aria-describedby="emailHelp">
                    <i class="fas fa-envelope input-icon" aria-hidden="true"></i>
                </div>
                <small id="emailHelp" class="visually-hidden">أدخل بريدك الإلكتروني بصيغة صحيحة</small>
            </div>

            <!-- كلمة المرور -->
            <div class="form-group">
                <label class="form-label" for="password">
                    <i class="fas fa-lock me-1" aria-hidden="true"></i> كلمة المرور
                </label>
                <div class="position-relative">
                    <input
                        type="password"
                        class="form-control with-icon"
                        id="password"
                        name="password"
                        placeholder="••••••••"
                        required
                        autocomplete="current-password"
                        aria-required="true">
                    <i class="fas fa-lock input-icon" aria-hidden="true"></i>
                    <button type="button" class="password-toggle btn btn-link p-0 text-decoration-none" id="togglePassword" aria-label="إظهار/إخفاء كلمة المرور" title="إظهار/إخفاء كلمة المرور">
                        <i class="fas fa-eye" aria-hidden="true"></i>
                    </button>
                </div>
            </div>

            <!-- تذكرني -->
            <div class="remember-me">
                <input type="checkbox" id="remember_me" name="remember_me" value="1" aria-describedby="rememberNote">
                <label for="remember_me">تذكرني لمدة 3 شهور</label>
            </div>
            <small id="rememberNote" class="visually-hidden">عند التفعيل سيتم تذكر بريدك في الجهاز الحالي</small>

            <button type="submit" class="btn-login" id="loginBtn">
                <span class="btn-text">تسجيل الدخول</span>
                <div class="loading"><div class="spinner" role="status" aria-label="جاري التحميل"></div></div>
            </button>
        </form>

        <div class="auth-links">
            <p class="mb-3">
                <a href="#" class="auth-link"><i class="fas fa-key me-1" aria-hidden="true"></i> نسيت كلمة المرور؟</a>
            </p>
            <p class="mb-0">
                ليس لديك حساب؟
                <a href="{% url 'accounts:register' %}" class="auth-link"><i class="fas fa-user-plus me-1" aria-hidden="true"></i> إنشاء حساب جديد</a>
            </p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('loginForm');
            const loginBtn = document.getElementById('loginBtn');
            const btnText = loginBtn.querySelector('.btn-text');
            const loading = loginBtn.querySelector('.loading');
            const togglePasswordBtn = document.getElementById('togglePassword');
            const togglePasswordIcon = togglePasswordBtn.querySelector('i');
            const passwordField = document.getElementById('password');
            const emailField = document.getElementById('email');
            const rememberChk = document.getElementById('remember_me');

            // إظهار/إخفاء كلمة المرور
            togglePasswordBtn.addEventListener('click', function() {
                const isHidden = passwordField.type === 'password';
                passwordField.type = isHidden ? 'text' : 'password';
                togglePasswordIcon.classList.toggle('fa-eye', !isHidden);
                togglePasswordIcon.classList.toggle('fa-eye-slash', isHidden);
                this.setAttribute('aria-pressed', String(isHidden));
            });

            // تنظيف البريد الإلكتروني
            emailField.addEventListener('blur', function() {
                this.value = this.value.trim().toLowerCase();
            });

            // معالجة الإرسال + تحقق بسيط
            form.addEventListener('submit', function(e) {
                const email = emailField.value.trim().toLowerCase();
                const password = passwordField.value;

                if (!email || !password) {
                    e.preventDefault();
                    showAlert('يرجى ملء جميع الحقول المطلوبة', 'danger');
                    return;
                }
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    e.preventDefault();
                    showAlert('البريد الإلكتروني غير صحيح', 'danger');
                    emailField.focus();
                    return;
                }

                emailField.value = email;

                // حالة التحميل
                btnText.style.display = 'none';
                loading.style.display = 'block';
                loginBtn.disabled = true;
            });

            // تنبيه عائم
            function showAlert(message, type) {
                const el = document.createElement('div');
                el.className = `alert alert-${type} alert-dismissible fade show`;
                const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
                el.innerHTML = `<i class="fas fa-${icon} me-2" aria-hidden="true"></i>${message}`;
                const header = document.querySelector('.auth-header');
                header.parentNode.insertBefore(el, form);

                setTimeout(() => { el?.remove(); }, 5000);
                setTimeout(() => {
                    btnText.style.display = 'inline';
                    loading.style.display = 'none';
                    loginBtn.disabled = false;
                }, 800);
            }

            // احترام تفضيل تقليل الحركة
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.body.style.animation = 'none';
                document.body.style.transition = 'none';
                const logo = document.querySelector('.logo-container');
                if (logo) logo.style.animation = 'none';
            }

            // رسائل Django الجاهزة (إن وجدت)
            document.querySelectorAll('.alert').forEach(a => setTimeout(() => a?.remove(), 5000));

            // تذكرني: حفظ البريد محليًا
            try {
                if (localStorage.getItem('rememberedEmail')) {
                    emailField.value = localStorage.getItem('rememberedEmail');
                    rememberChk.checked = true;
                }
                rememberChk.addEventListener('change', function() {
                    if (this.checked && emailField.value.trim()) {
                        localStorage.setItem('rememberedEmail', emailField.value.trim().toLowerCase());
                    } else {
                        localStorage.removeItem('rememberedEmail');
                    }
                });
            } catch (_) { /* ignore */ }
        });
    </script>
</body>
</html>
