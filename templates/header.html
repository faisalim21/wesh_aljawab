<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#5b21b6">

  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --primary-start:#7c3aed; /* أغمق قليلًا */
      --primary-end:#0ea5e9;   /* أغمق قليلًا */
      --brand-bg:#ffffff; --text:#1f2937;
      --navbar-grad:linear-gradient(135deg, rgba(124,58,237,.97), rgba(14,165,233,.97));
      --navbar-grad-scrolled:linear-gradient(135deg, rgba(88,28,135,.98), rgba(12,74,110,.98));
      --radius:16px; --transition:.35s cubic-bezier(.22,.61,.36,1);
      --elev:0 12px 30px rgba(0,0,0,.18);
    }

    html,body{ background:var(--brand-bg); color:var(--text); }

    .navbar{
      background:var(--navbar-grad);
      -webkit-backdrop-filter:blur(10px);
      backdrop-filter:blur(10px);
      padding:.75rem 0;
      transition:padding .25s ease, box-shadow .25s ease, background .25s ease;
      box-shadow:0 2px 20px rgba(0,0,0,.10);
    }
    .navbar.navbar-scrolled{
      background:var(--navbar-grad-scrolled);
      box-shadow:0 6px 28px rgba(0,0,0,.20);
      padding:.5rem 0;
    }

    .logo-container{
      background:linear-gradient(145deg, rgba(255,255,255,.95), rgba(255,255,255,.85));
      border-radius:var(--radius);
      padding:10px 14px;
      transition:transform var(--transition), box-shadow var(--transition);
      box-shadow:0 8px 25px rgba(0,0,0,.15), inset 0 1px 0 rgba(255,255,255,.8);
      border:1px solid rgba(255,255,255,.3);
    }
    .logo-container:hover{ transform:translateY(-3px) scale(1.02); }
    .logo-img{ height:58px; width:auto; }

    .nav-link{
      color:rgba(255,255,255,.95)!important; font-weight:500;
      padding:.7rem .9rem!important; border-radius:10px;
      transition:color var(--transition), background var(--transition), transform var(--transition);
      margin:0 .2rem;
      will-change:transform;
    }
    .nav-link:hover{ color:#fff!important; background:rgba(255,255,255,.14); transform:translateY(-2px); }
    .nav-link.active{ background:rgba(255,255,255,.22); color:#fff!important; }

    .custom-dropdown{
      border:none; border-radius:12px; box-shadow:var(--elev);
      padding:.35rem 0; min-width:260px;
      /* حركة ناعمة */
      opacity:0; transform:translateY(8px) scale(.98);
      transition:opacity .22s ease, transform .22s ease;
      display:block; visibility:hidden;
    }
    .dropdown.show > .custom-dropdown,
    .dropdown-menu.show{
      opacity:1; transform:translateY(0) scale(1);
      visibility:visible;
    }
    .dropdown-item{ padding:.7rem 1rem; font-weight:500; border-radius:10px; transition:background .2s ease, transform .2s ease; }
    .dropdown-item:hover{ background:linear-gradient(135deg, rgba(139,92,246,.12), rgba(6,182,212,.12)); color:#7c3aed; transform:translateX(-2px); }

    .game-status-badge{ font-size:.7rem; padding:.25rem .55rem; border-radius:14px; font-weight:700; }
    .available{ background:rgba(16,185,129,.12); color:#059669; }
    .coming-soon{ background:rgba(245,158,11,.12); color:#d97706; }

    /* قائمة المستخدم أفقية */
    .user-menu{
      display:flex !important; align-items:center !important; flex-direction:row !important;
      gap:.6rem !important; background:rgba(255,255,255,.14);
      border-radius:25px; padding:.4rem .9rem!important; white-space:nowrap;
      transition:background .2s ease, box-shadow .2s ease, transform .2s ease;
    }
    .user-menu:hover{ background:rgba(255,255,255,.18); transform:translateY(-1px); }
    .user-menu .user-avatar{ width:34px; height:34px; background:#fff; color:#7c3aed; border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
    .user-menu .user-name{ overflow:hidden; text-overflow:ellipsis; max-width:14ch; line-height:1.2; flex-shrink:1; }
    .user-menu.dropdown-toggle::after{ margin-inline-start:.35rem; }

    .btn-outline-light{
      border:2px solid rgba(255,255,255,.35); color:#fff; font-weight:600; padding:.45rem 1.25rem; border-radius:25px; transition:var(--transition);
    }
    .btn-outline-light:hover{ background:#fff; color:#7c3aed; border-color:#fff; transform:translateY(-2px); box-shadow:0 5px 15px rgba(255,255,255,.25); }

    .btn-primary{
      background:linear-gradient(135deg,#f59e0b,#f97316); border:none; font-weight:700; padding:.5rem 1.25rem; border-radius:25px; color:#fff; transition:var(--transition);
    }
    .btn-primary:hover{ background:linear-gradient(135deg,#f97316,#ea580c); transform:translateY(-2px); box-shadow:0 5px 15px rgba(245,158,11,.35); }

    /* الهامبرغر -> X */
    .custom-toggler{
      border:none !important; width:44px; height:44px; background:rgba(255,255,255,.14) !important;
      border-radius:10px; display:flex; flex-direction:column; justify-content:center; align-items:center;
      cursor:pointer; transition:background .2s ease, transform .2s ease; position:relative; z-index:1051; padding:0 !important;
    }
    .custom-toggler:hover{ background:rgba(255,255,255,.2) !important; transform:translateY(-1px); }
    .custom-toggler:focus{ box-shadow: none !important; }
    .toggler-icon{ width:25px; height:3px; background:#fff; border-radius:2px; display:block; transition:all .3s ease; margin:2px 0; position:relative; }
    .custom-toggler[aria-expanded="true"] .toggler-icon:nth-child(1){ transform:rotate(45deg) translate(6px, 6px); }
    .custom-toggler[aria-expanded="true"] .toggler-icon:nth-child(2){ opacity:0; }
    .custom-toggler[aria-expanded="true"] .toggler-icon:nth-child(3){ transform:rotate(-45deg) translate(6px, -6px); }

    /* حركة ناعمة لقائمة الجوال باستخدام ScaleY */
    .navbar-collapse{
      transform-origin: top;
      transform: scaleY(0.98);
      opacity:0;
      transition: transform .22s ease, opacity .22s ease;
      will-change: transform, opacity;
    }
    .navbar-collapse.show{
      transform: scaleY(1);
      opacity:1;
    }

    /* Mobile */
    @media (max-width: 991.98px){
      .navbar-collapse{
        background:rgba(255,255,255,.97);
        border-radius:14px; padding:1rem; margin-top:.75rem;
        box-shadow:0 10px 25px rgba(0,0,0,.1);
      }
      .nav-link{ color:#2d3748!important; }
      .nav-link:hover{ background:linear-gradient(135deg, rgba(139,92,246,.10), rgba(6,182,212,.10)); color:#7c3aed!important; }
      .nav-link.active{ background:linear-gradient(135deg, rgba(139,92,246,.16), rgba(6,182,212,.16)); color:#7c3aed!important; }

      .user-menu{ background:linear-gradient(135deg, rgba(139,92,246,.08), rgba(6,182,212,.08)); color:#2d3748!important; border-radius:10px; }
      .user-menu .user-name{ max-width:18ch; }
      /* نجعل dropdown داخل الجوال بلا ظل ويستفيد من الحركة العامة */
      .dropdown-menu.show{
        position:static!important; transform:none!important; box-shadow:none!important; border:none!important;
        margin:.5rem 0 0 0!important; padding:0!important; background:transparent!important;
        opacity:1!important; visibility:visible!important;
      }
      .dropdown-item{ background:rgba(139,92,246,.06)!important; margin:.25rem 0; border-radius:8px; color:#2d3748!important; }
      .dropdown-item:hover{ background:linear-gradient(135deg, rgba(139,92,246,.14), rgba(6,182,212,.14))!important; }
    }

    /* Spacer */
    #header-spacer{ width:100%; }

    /* احترام تفضيل تقليل الحركة */
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; }
    }
  </style>
</head>
<body>

<header class="main-header" role="banner">
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top" aria-label="الشريط العلوي">
    <div class="container">
      <!-- Logo -->
      <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}" aria-label="الرئيسية - وش الجواب">
        <div class="logo-container">
          <img src="https://res.cloudinary.com/drbfhq7t1/image/upload/v1754178528/weshaljawab_tltnqt.png" alt="وش الجواب" class="logo-img" width="160" height="60" loading="eager" decoding="async"/>
        </div>
      </a>

      <!-- Toggler المُحسن -->
      <button class="navbar-toggler custom-toggler" type="button"
              aria-controls="navbarNav" aria-expanded="false" aria-label="تبديل القائمة"
              id="navToggler">
        <span class="toggler-icon"></span>
        <span class="toggler-icon"></span>
        <span class="toggler-icon"></span>
      </button>

      <!-- Menu -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto" role="menubar">
          <li class="nav-item" role="none">
            <a class="nav-link" href="{% url 'home' %}" role="menuitem">
              <i class="fas fa-home me-1" aria-hidden="true"></i>
              الرئيسية
            </a>
          </li>

          <li class="nav-item dropdown" role="none">
            <a class="nav-link dropdown-toggle" href="#" role="button"
               data-bs-toggle="dropdown" aria-expanded="false" id="gamesDropdown">
              <i class="fas fa-gamepad me-1" aria-hidden="true"></i>
              الألعاب
            </a>
            <ul class="dropdown-menu custom-dropdown" role="menu" aria-labelledby="gamesDropdown">
              <li role="none">
                <a class="dropdown-item d-flex justify-content-between align-items-center" href="{% url 'games:letters_home' %}" role="menuitem">
                  <span><i class="fas fa-font me-2"></i> خلية الحروف</span>
                  <span class="game-status-badge available">متاح</span>
                </a>
              </li>
              <li role="none">
                <a class="dropdown-item d-flex justify-content-between align-items-center" href="{% url 'games:images_home' %}" role="menuitem">
                  <span><i class="fas fa-images me-2"></i> تحدي الصور</span>
                  <span class="game-status-badge available">متاح</span>
                </a>
              </li>
              <li role="none">
                <a class="dropdown-item d-flex justify-content-between align-items-center disabled" href="#" role="menuitem" aria-disabled="true" tabindex="-1">
                  <span><i class="fas fa-question-circle me-2"></i> سؤال وجواب</span>
                  <span class="game-status-badge coming-soon">قريباً</span>
                </a>
              </li>
            </ul>
          </li>

          <!-- أزلت رابط "تواصل معنا" واستبدلته بزر واتساب يمين -->
        </ul>

        <!-- User Actions + زر واتساب -->
        <div class="navbar-nav ms-auto align-items-center gap-2">
          <!-- زر واتساب ثابت وآمن -->
          <a class="btn btn-success d-inline-flex align-items-center"
             href="https://wa.me/966550799857"
             target="_blank" rel="noopener"
             aria-label="تواصل واتساب على الرقم 0550799857"
             style="border-radius:25px; font-weight:700;">
            <i class="fab fa-whatsapp fa-lg me-2" aria-hidden="true"></i>
            واتساب
          </a>

          {% if user.is_authenticated %}
          <div class="nav-item dropdown">
            <a class="nav-link dropdown-toggle user-menu" href="#" role="button"
               data-bs-toggle="dropdown" aria-expanded="false" id="userDropdown">
              <div class="user-avatar" aria-hidden="true"><i class="fas fa-user"></i></div>
              <span class="user-name">{{ user.profile.display_name|default:user.username }}</span>
            </a>
            <ul class="dropdown-menu custom-dropdown user-dropdown" role="menu" aria-labelledby="userDropdown">
              <li class="px-3 py-2"><small class="text-muted d-block">{{ user.email }}</small></li>
              <li><hr class="dropdown-divider" /></li>
              <li role="none">
                <a class="dropdown-item" href="{% url 'payments:history' %}" role="menuitem">
                  <i class="fas fa-credit-card me-2" aria-hidden="true"></i> مشترياتي
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li role="none">
                <a class="dropdown-item text-danger" href="{% url 'accounts:logout' %}" role="menuitem">
                  <i class="fas fa-sign-out-alt me-2" aria-hidden="true"></i> تسجيل الخروج
                </a>
              </li>
            </ul>
          </div>
          {% else %}
          <div class="auth-buttons d-flex align-items-center gap-2">
            <a href="{% url 'accounts:login' %}" class="btn btn-outline-light">
              <i class="fas fa-sign-in-alt me-1" aria-hidden="true"></i> دخول
            </a>
            <a href="{% url 'accounts:register' %}" class="btn btn-primary">
              <i class="fas fa-user-plus me-1" aria-hidden="true"></i> تسجيل جديد
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </nav>
</header>

<!-- Spacer لمنع تداخل الهيدر الثابت مع المحتوى -->
<div id="header-spacer" aria-hidden="true"></div>

<!-- Bootstrap JS -->
<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
(function(){
  'use strict';

  const navbar = document.querySelector('.navbar');
  const spacer = document.getElementById('header-spacer');
  const navCollapse = document.getElementById('navbarNav');
  const toggler = document.getElementById('navToggler');

  // Spacer height
  function setSpacerHeight(){
    if(spacer && navbar){ spacer.style.height = navbar.getBoundingClientRect().height + 'px'; }
  }
  setSpacerHeight();
  if('ResizeObserver' in window && navbar){
    new ResizeObserver(setSpacerHeight).observe(navbar);
  } else {
    window.addEventListener('resize', setSpacerHeight, { passive:true });
  }

  // Scroll effect
  function onScroll(){
    if(!navbar) return;
    (window.scrollY > 50) ? navbar.classList.add('navbar-scrolled') : navbar.classList.remove('navbar-scrolled');
  }
  onScroll(); window.addEventListener('scroll', onScroll, { passive:true });

  // Active link
  (function highlightActive(){
    const currentPath = (window.location.pathname.replace(/\/+$/, '') || '/');
    document.querySelectorAll('.nav-link[href]').forEach(link=>{
      const href = link.getAttribute('href') || '';
      if(href.startsWith('#')) return;
      const normalized = (href.replace(/\/+$/, '') || '/');
      if(currentPath === normalized || (normalized !== '/' && currentPath.startsWith(normalized))){
        link.classList.add('active');
      }
    });
  })();

  // ===== تحكم يدوي بالهامبرغر (سلسلة وناعمة) =====
  if(toggler && navCollapse){
    toggler.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const isExpanded = toggler.getAttribute('aria-expanded') === 'true';
      if(isExpanded) {
        navCollapse.classList.remove('show');
        toggler.setAttribute('aria-expanded', 'false');
      } else {
        navCollapse.classList.add('show');
        toggler.setAttribute('aria-expanded', 'true');
      }
    });

    // إغلاق عند النقر خارج القائمة
    document.addEventListener('click', function(e) {
      if(window.innerWidth <= 991) {
        const isClickInsideNav = navCollapse.contains(e.target);
        const isClickOnToggler = toggler.contains(e.target);
        if(!isClickInsideNav && !isClickOnToggler && navCollapse.classList.contains('show')) {
          navCollapse.classList.remove('show');
          toggler.setAttribute('aria-expanded', 'false');
        }
      }
    });

    // إغلاق عند تغيير حجم الشاشة للديسكتوب
    window.addEventListener('resize', function(){
      if(window.innerWidth > 991 && navCollapse.classList.contains('show')) {
        navCollapse.classList.remove('show');
        toggler.setAttribute('aria-expanded', 'false');
      }
    }, { passive:true });
  }

  // إغلاق القائمة عند النقر على العناصر
  document.querySelectorAll('#navbarNav a.nav-link:not(.dropdown-toggle), #navbarNav .dropdown-item:not(.disabled)').forEach(link=>{
    link.addEventListener('click', function(){
      if(window.innerWidth <= 991 && navCollapse?.classList.contains('show')){
        navCollapse.classList.remove('show');
        toggler.setAttribute('aria-expanded', 'false');
      }
    });
  });

  // Desktop hover only (مع سلاسة CSS)
  const dropdowns = document.querySelectorAll('.nav-item.dropdown');
  const isDesktop = () => window.matchMedia('(pointer:fine)').matches && window.innerWidth > 991;

  function onEnter(){
    if(!isDesktop()) return;
    this.classList.add('show');
    this.querySelector('.dropdown-toggle')?.setAttribute('aria-expanded','true');
    this.querySelector('.dropdown-menu')?.classList.add('show');
  }
  function onLeave(){
    if(!isDesktop()) return;
    this.classList.remove('show');
    this.querySelector('.dropdown-toggle')?.setAttribute('aria-expanded','false');
    this.querySelector('.dropdown-menu')?.classList.remove('show');
  }
  function bindDesktopHover(){ dropdowns.forEach(dd=>{ dd.addEventListener('mouseenter', onEnter); dd.addEventListener('mouseleave', onLeave); }); }
  function unbindDesktopHover(){ dropdowns.forEach(dd=>{ dd.removeEventListener('mouseenter', onEnter); dd.removeEventListener('mouseleave', onLeave); }); }
  function refreshHover(){ unbindDesktopHover(); if(isDesktop()) bindDesktopHover(); }
  refreshHover(); window.addEventListener('resize', refreshHover, { passive:true });

  // Mobile dropdown: واحد فقط مفتوح
  document.querySelectorAll('.dropdown-toggle').forEach(toggle=>{
    toggle.addEventListener('click', function(e){
      if(window.innerWidth <= 991){
        e.preventDefault(); e.stopPropagation();
        const dd = this.closest('.dropdown');
        const menu = dd?.querySelector('.dropdown-menu');
        if(!dd || !menu) return;

        document.querySelectorAll('.dropdown-menu.show').forEach(other=>{
          if(other !== menu){ other.classList.remove('show'); other.closest('.dropdown')?.classList.remove('show'); }
        });

        dd.classList.toggle('show'); menu.classList.toggle('show');
        this.setAttribute('aria-expanded', menu.classList.contains('show'));
      }
    });
  });

  document.querySelectorAll('.dropdown-menu').forEach(menu=>{
    menu.addEventListener('click', e=>{ if(window.innerWidth <= 991) e.stopPropagation(); });
  });
})();
</script>

</body>
</html>
